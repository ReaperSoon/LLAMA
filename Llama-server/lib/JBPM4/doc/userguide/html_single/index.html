<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">jBPM User Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.72.0"/></head><body><div class="book" lang="en"><div class="titlepage"><div><p id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e1"/>jBPM User Guide</h1></div></div><hr/></div><div class="toc"><dl><dt><span class="chapter"><a href="#introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e14">1.1. License and EULA</a></span></dt><dt><span class="section"><a href="#d0e25">1.2. Downloads</a></span></dt><dt><span class="section"><a href="#d0e32">1.3. Sources</a></span></dt><dt><span class="section"><a href="#d0e39">1.4. What is it</a></span></dt><dt><span class="section"><a href="#d0e44">1.5. Contents of this userguide</a></span></dt><dt><span class="section"><a href="#d0e51">1.6. Migration from jBPM 3</a></span></dt><dt><span class="section"><a href="#d0e56">1.7. Reporting problems</a></span></dt></dl></dd><dt><span class="chapter"><a href="#installation">2. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#thedistribution">2.1. The distribution</a></span></dt><dt><span class="section"><a href="#d0e140">2.2. Required software</a></span></dt><dt><span class="section"><a href="#gettingstartedquickly">2.3. Getting started quickly</a></span></dt><dt><span class="section"><a href="#installscripts">2.4. Install scripts</a></span></dt><dt><span class="section"><a href="#librarydependenciesandconfigurationfiles">2.5. Library dependencies and configuration files</a></span></dt><dt><span class="section"><a href="#jboss">2.6. JBoss</a></span></dt><dt><span class="section"><a href="#tomcat">2.7. Tomcat</a></span></dt><dt><span class="section"><a href="#signavio">2.8. Signavio web based process editor</a></span></dt><dt><span class="section"><a href="#userwebapp">2.9. User webapp</a></span></dt><dt><span class="section"><a href="#database">2.10. Database</a></span></dt><dd><dl><dt><span class="section"><a href="#createdropdb">2.10.1. Creating or dropping the database schema</a></span></dt><dt><span class="section"><a href="#upgradedb">2.10.2. Upgrading an existing database</a></span></dt></dl></dd><dt><span class="section"><a href="#graphicalprocessdesigner">2.11. Graphical Process Designer (GPD)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e645">2.11.1. Get Eclipse</a></span></dt><dt><span class="section"><a href="#d0e660">2.11.2. Install the GPD plugin into eclipse</a></span></dt><dt><span class="section"><a href="#d0e723">2.11.3. Configuring the jBPM runtime</a></span></dt><dt><span class="section"><a href="#definejbpmuserlibraries">2.11.4. Define the jBPM User Library</a></span></dt><dt><span class="section"><a href="#d0e877">2.11.5. Adding jPDL 4 schema to the catalog</a></span></dt><dt><span class="section"><a href="#d0e916">2.11.6. Importing the Examples</a></span></dt><dt><span class="section"><a href="#d0e967">2.11.7. Adding deployment with ant</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#graphicalprocessdesigner">3. Graphical Process Designer (GPD)</a></span></dt><dd><dl><dt><span class="section"><a href="#creatingnewprocessfile">3.1. Creating a new process file</a></span></dt><dt><span class="section"><a href="#editingtheprocesssource">3.2. Editing the process source</a></span></dt></dl></dd><dt><span class="chapter"><a href="#deployingbusinessarchives">4. Deploying business archives</a></span></dt><dd><dl><dt><span class="section"><a href="#deployingprocessfilesandprocessresources">4.1. Deploying process files and process resources</a></span></dt><dt><span class="section"><a href="#deployingclasses">4.2. Deploying classes</a></span></dt></dl></dd><dt><span class="chapter"><a href="#services">5. Services</a></span></dt><dd><dl><dt><span class="section"><a href="#processdefinitionprocessinstanceandexecutions">5.1. Process definition, process instance and executions</a></span></dt><dt><span class="section"><a href="#processengine">5.2. ProcessEngine</a></span></dt><dt><span class="section"><a href="#deployingaprocess">5.3. Deploying a process</a></span></dt><dt><span class="section"><a href="#deletingadeployment">5.4. Deleting a deployment</a></span></dt><dt><span class="section"><a href="#startinganewprocessinstance">5.5. Starting a new process instance</a></span></dt><dd><dl><dt><span class="section"><a href="#inlatest">5.5.1. In latest</a></span></dt><dt><span class="section"><a href="#specificprocessversion">5.5.2. Specific process version</a></span></dt><dt><span class="section"><a href="#withakey">5.5.3. With a key</a></span></dt><dt><span class="section"><a href="#withvariables">5.5.4. With variables</a></span></dt></dl></dd><dt><span class="section"><a href="#singallingawaitingexecution">5.6. Signalling a waiting execution</a></span></dt><dt><span class="section"><a href="#taskservice">5.7. TaskService</a></span></dt><dt><span class="section"><a href="#historyservice">5.8. HistoryService</a></span></dt><dt><span class="section"><a href="#managementservice">5.9. ManagementService</a></span></dt><dt><span class="section"><a href="#queryApi">5.10. Query API</a></span></dt></dl></dd><dt><span class="chapter"><a href="#jpdl">6. jPDL</a></span></dt><dd><dl><dt><span class="section"><a href="#process">6.1. <code class="literal">process</code></a></span></dt><dt><span class="section"><a href="#controlflowactivities">6.2. Control flow activities</a></span></dt><dd><dl><dt><span class="section"><a href="#start">6.2.1. <code class="literal">start</code></a></span></dt><dt><span class="section"><a href="#state">6.2.2. <code class="literal">state</code></a></span></dt><dt><span class="section"><a href="#decision">6.2.3. <code class="literal">decision</code></a></span></dt><dt><span class="section"><a href="#concurrency">6.2.4. <code class="literal">concurrency</code></a></span></dt><dt><span class="section"><a href="#end">6.2.5. <code class="literal">end</code></a></span></dt><dt><span class="section"><a href="#task">6.2.6. <code class="literal">task</code></a></span></dt><dt><span class="section"><a href="#subprocess">6.2.7. <code class="literal">sub-process</code></a></span></dt><dt><span class="section"><a href="#custom">6.2.8. <code class="literal">custom</code></a></span></dt></dl></dd><dt><span class="section"><a href="#automaticactivities">6.3. Automatic activities</a></span></dt><dd><dl><dt><span class="section"><a href="#java">6.3.1. <code class="literal">java</code></a></span></dt><dt><span class="section"><a href="#script">6.3.2. <code class="literal">script</code></a></span></dt><dt><span class="section"><a href="#hql">6.3.3. <code class="literal">hql</code></a></span></dt><dt><span class="section"><a href="#sql">6.3.4. <code class="literal">sql</code></a></span></dt><dt><span class="section"><a href="#mail">6.3.5. <code class="literal">mail</code></a></span></dt></dl></dd><dt><span class="section"><a href="#commonactivitycontents">6.4. Common activity contents</a></span></dt><dt><span class="section"><a href="#events">6.5. Events</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4606">6.5.1. Event listener example</a></span></dt><dt><span class="section"><a href="#d0e4640">6.5.2. Event propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#asynchronouscontinuations">6.6. Asynchronous continuations</a></span></dt><dd><dl><dt><span class="section"><a href="#asyncactivity">6.6.1. Async activity</a></span></dt><dt><span class="section"><a href="#asyncfork">6.6.2. Async fork</a></span></dt></dl></dd><dt><span class="section"><a href="#usercode">6.7. User code</a></span></dt><dd><dl><dt><span class="section"><a href="#usercodeconfiguration">6.7.1. User code configuration</a></span></dt><dt><span class="section"><a href="#usercodeclassloading">6.7.2. User code classloading</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="#variables">7. Variables</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5153">7.1. Variable scoping</a></span></dt><dt><span class="section"><a href="#d0e5171">7.2. Variable types</a></span></dt><dt><span class="section"><a href="#d0e5209">7.3. Updating serialized process variables</a></span></dt><dt><span class="section"><a href="#d0e5231">7.4. Declared variables</a></span></dt><dt><span class="section"><a href="#variablehistory">7.5. Variables history</a></span></dt></dl></dd><dt><span class="chapter"><a href="#scripting">8. Scripting</a></span></dt><dt><span class="chapter"><a href="#configuration">9. Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e5447">9.1. Business calendar</a></span></dt><dt><span class="section"><a href="#d0e5454">9.2. Console</a></span></dt><dt><span class="section"><a href="#d0e5467">9.3. Email</a></span></dt></dl></dd></dl></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="introduction"/>Chapter 1. Introduction</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e14">1.1. License and EULA</a></span></dt><dt><span class="section"><a href="#d0e25">1.2. Downloads</a></span></dt><dt><span class="section"><a href="#d0e32">1.3. Sources</a></span></dt><dt><span class="section"><a href="#d0e39">1.4. What is it</a></span></dt><dt><span class="section"><a href="#d0e44">1.5. Contents of this userguide</a></span></dt><dt><span class="section"><a href="#d0e51">1.6. Migration from jBPM 3</a></span></dt><dt><span class="section"><a href="#d0e56">1.7. Reporting problems</a></span></dt></dl></div><p>This documentation is best viewed in <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.mozilla.com/firefox/">firefox</a>. There are some known issues
  with internet explorer.
  </p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e14"/>1.1. License and EULA</h2></div></div></div><p>jBPM is distributed under the terms of the 
    GNU Lesser General Public License (LGPL) and the JBoss End User License Agreement (EULA).  
    See <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../../../license.txt">the full LGPL license text</a> and <a xmlns:xlink="http://www.w3.org/1999/xlink" href="../../../jboss.eula.txt">the 
    full End User License Agreement</a>. 
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e25"/>1.2. Downloads</h2></div></div></div><p>The distribution packages can be downloaded from sourceforge
    </p><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://sourceforge.net/projects/jbpm/files/">http://sourceforge.net/projects/jbpm/files/</a></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e32"/>1.3. Sources</h2></div></div></div><p>The source code for this component can be found in the jBPM SVN repository:
    </p><a xmlns:xlink="http://www.w3.org/1999/xlink" href="https://anonsvn.jboss.org/repos/jbpm/jbpm4/">https://anonsvn.jboss.org/repos/jbpm/jbpm4/</a></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e39"/>1.4. What is it</h2></div></div></div><p>jBPM is an extensible and flexible process engine that can run 
    as a standalone server or embedded in any Java application.
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e44"/>1.5. Contents of this userguide</h2></div></div></div><p>In this user guide, we'll describe the jPDL 
    process language in persistent execution mode.  Persistent 
    execution mode means that process definitions, process executions 
    and process history is stored in a relational DB.  This is the common way 
    of how jBPM is used in practice. 
    </p><p>This user guide explains the supported way on how to use jBPM.
    The developers guide explains more advanced customization options that 
    are not part of the support offerings. 
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e51"/>1.6. Migration from jBPM 3</h2></div></div></div><p>Migration from jBPM 3 to jBPM 4 is not supported. 
    Check out the developers guide for hints on how to perform the migration.
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e56"/>1.7. Reporting problems</h2></div></div></div><p>When reporting a problem in the user forum or in our support portal, please 
    use the following snippet as a template:
    </p><pre class="programlisting"><span class="bold"><strong>=== Environment ==============================</strong></span>
- <span class="bold"><strong>jBPM Version</strong></span> : which version of jBPM are you using?
- <span class="bold"><strong>Database</strong></span> : which database and which version of that database
- <span class="bold"><strong>JDK</strong></span> : which Java version are you using? use 'java -version' to find out
- <span class="bold"><strong>Container</strong></span> : which container are you using? (JBoss, Tomcat, etc.)
- <span class="bold"><strong>Configuration</strong></span> : is your jbpm.cfg.xml only using imports from the jbpm.jar
   lib itself? or did you create a custom config file?
- <span class="bold"><strong>Libraries</strong></span> : are you using the exact versions of the libs from inside the jbpm
   distribution of the version that you're using? or did you change some of the libs?

<span class="bold"><strong>=== Process ==================================</strong></span>
paste jPDL process here

<span class="bold"><strong>=== API ===================================</strong></span>
paste the relevant code snippet that you use to invoke jBPM

<span class="bold"><strong>=== Stacktrace ==============================</strong></span>
paste full stack trace here

<span class="bold"><strong>=== Debug logs ==============================</strong></span>
paste debug logs here

<span class="bold"><strong>=== Problem description =========================</strong></span>
Keep this part short and to the point. E.g. API doesn't work as expected. 
or e.g. method ExecutionService.signalExecutionById throws exception.</pre><p>Clever readers will have noticed that some of these questions point to probably causes :-)
    Especially tweaking the libs and configuration can easily lead to trouble.  That's why 
    we have spend a great deal of effort to include default installations and a simplified 
    configuration mechanism with imports.  Think twice before you start to customize 
    configurations beyond what is indicated in this userguide.  Also think twice before 
    replacing libs with other versions.     
    </p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="installation"/>Chapter 2. Installation</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#thedistribution">2.1. The distribution</a></span></dt><dt><span class="section"><a href="#d0e140">2.2. Required software</a></span></dt><dt><span class="section"><a href="#gettingstartedquickly">2.3. Getting started quickly</a></span></dt><dt><span class="section"><a href="#installscripts">2.4. Install scripts</a></span></dt><dt><span class="section"><a href="#librarydependenciesandconfigurationfiles">2.5. Library dependencies and configuration files</a></span></dt><dt><span class="section"><a href="#jboss">2.6. JBoss</a></span></dt><dt><span class="section"><a href="#tomcat">2.7. Tomcat</a></span></dt><dt><span class="section"><a href="#signavio">2.8. Signavio web based process editor</a></span></dt><dt><span class="section"><a href="#userwebapp">2.9. User webapp</a></span></dt><dt><span class="section"><a href="#database">2.10. Database</a></span></dt><dd><dl><dt><span class="section"><a href="#createdropdb">2.10.1. Creating or dropping the database schema</a></span></dt><dt><span class="section"><a href="#upgradedb">2.10.2. Upgrading an existing database</a></span></dt></dl></dd><dt><span class="section"><a href="#graphicalprocessdesigner">2.11. Graphical Process Designer (GPD)</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e645">2.11.1. Get Eclipse</a></span></dt><dt><span class="section"><a href="#d0e660">2.11.2. Install the GPD plugin into eclipse</a></span></dt><dt><span class="section"><a href="#d0e723">2.11.3. Configuring the jBPM runtime</a></span></dt><dt><span class="section"><a href="#definejbpmuserlibraries">2.11.4. Define the jBPM User Library</a></span></dt><dt><span class="section"><a href="#d0e877">2.11.5. Adding jPDL 4 schema to the catalog</a></span></dt><dt><span class="section"><a href="#d0e916">2.11.6. Importing the Examples</a></span></dt><dt><span class="section"><a href="#d0e967">2.11.7. Adding deployment with ant</a></span></dt></dl></dd></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="thedistribution"/>2.1. The distribution</h2></div></div></div><p>Unzip the jBPM download (<code class="literal">jbpm-4.X.zip</code>) to some location on your hard drive.
    You'll see following subdirectories:
    </p><div class="itemizedlist"><ul><li><code class="literal">doc</code>: User guide, javadocs and developers guide</li><li><code class="literal">examples</code>: Example processes that are used in the user guide</li><li><code class="literal">install</code>: Installation scripts for several environments</li><li><code class="literal">lib</code>: Third party libs and some special jBPM libraries</li><li><code class="literal">src</code>: Source files</li><li><code class="literal">migration</code>: see developers guide</li><li><code class="literal">jbpm.jar</code>: The jBPM main library archive</li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e140"/>2.2. Required software</h2></div></div></div><p>jBPM requires a JDK (standard java) version 5 or higher.
    </p><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/javase/downloads/index.jsp">http://java.sun.com/javase/downloads/index.jsp</a><p>To execute the ant scripts, you'll need apache ant version <span class="bold"><strong>1.7.0</strong></span> or higher:
    </p><a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://ant.apache.org/bindownload.cgi">http://ant.apache.org/bindownload.cgi</a></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="gettingstartedquickly"/>2.3. Getting started quickly</h2></div></div></div><p>The <span class="bold"><strong>demo setup</strong></span> is the simplest way to get started.
    This section describes the steps to complete the demo setup.
    </p><p>If you have previously downloaded <code class="literal">jboss-5.0.0.GA.zip</code>, you can drop it 
    in the <code class="literal">${jbpm.home}/install/downloads</code> directory.
    Otherwise the script will download it for you, but it will take some time (depending on your connection).
    The same is holds for eclipse-jee-galileo-win32.zip (or eclipse-jee-galileo-linux-gtk(-x86_64).tar.gz on Linux 
    and eclipse-jee-galileo-macosx-carbon.tar.gz on Mac OSX)
    </p><p>Open a command prompt and go do directory <code class="literal">${jbpm.home}/install</code>.  Then 
    run
    </p><pre class="programlisting">ant demo.setup.jboss</pre><p>or</p><pre class="programlisting">ant demo.setup.tomcat</pre><p>That will</p><div class="itemizedlist"><ul><li>Install JBoss into the <code class="literal">${jbpm.home}/jboss-5.0.0.GA</code> directory</li><li>Install jBPM into that JBoss installation.</li><li>Install hsqldb and start it in the background</li><li>Create the DB Schema</li><li>Start JBoss in the background.</li><li>Create an examples.bar business archive from the examples and deploy it to the jBPM DB.</li><li>Load the example users and groups from <code class="literal">${jbpm.home}/install/src/demo/example.identities.sql</code></li><li>Install eclipse into <code class="literal">${jbpm.home}/eclipse</code></li><li>Install the jBPM web console</li><li>Install the Signavio web modeler</li><li>Start eclipse</li></ul></div><p>
      After this is done, JBoss (or Tomcat, depending on which demo.setup script you chose) 
      will be running in the background. Once eclipse has started, you can continue to follow the instructions of
      <a href="#graphicalprocessdesigner" title="2.11. Graphical Process Designer (GPD)">Section 2.11, “Graphical Process Designer (GPD)”</a> to start coding your jBPM business processes.
    </p><p>
      Or you can start modeling processes through 
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jbpmeditor/p/explorer">the Signavio web editor</a>.
    </p><p>Or surf to <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://localhost:8080/jbpm-console">the jBPM console</a>.
    You can login as one of the following users:
    </p><div class="table"><a id="d0e227"/><p class="title"><b>Table 2.1. Example console users:</b></p><div class="table-contents"><table summary="Example console users:" border="1"><colgroup><col/><col/></colgroup><thead><tr><th>Username</th><th>Password</th></tr></thead><tbody><tr><td>alex</td><td>password</td></tr><tr><td>mike</td><td>password</td></tr><tr><td>peter</td><td>password</td></tr><tr><td>mary</td><td>password</td></tr></tbody></table></div></div><br class="table-break"/><p>
    <span class="bold"><strong>Known console limitation</strong></span>:
    Currently, the timeout of the console is too tight for the reporting
    to initialize on slower machines. So the first time when you access
    the reporting the request will timeout and the console crashes.
    Logging out and login again works around this problem. It's being
    addressed as issue
    <a xmlns:xlink="http://www.w3.org/1999/xlink" href="https://jira.jboss.org/jira/browse/JBPM-2508">JBPM-2508</a>
  </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="installscripts"/>2.4. Install scripts</h2></div></div></div><p>The jBPM download contains an <code class="literal">install</code> directory
	  with an ant build.xml file in it.  You can use that to 
	  install jBPM into your application environment. 
	  </p><p>It's best to stick to the installations and jBPM configuration files 
	  as done with these installation scripts.  Customizing jBPM configuration files 
	  directly, is possible, but not supported. 
	  </p><p>
    To invoke the install script, open a command line and go to the 
    <code class="literal">${jbpm.home}/install</code> directory.  With <code class="literal">ant -p</code> you can 
    find out what each of these scripts can do. The scripts are parametrized with default values
    to get going quickly. The following list gives an overview of the available scripts:
    </p><p>
      </p><div class="itemizedlist"><ul><li><code class="literal">demo.setup.jboss</code>: installs jboss, installs jbpm into jboss, 
        starts jboss, creates the jBPM DB schema, deploys examples, loads example identities,
        installs and starts eclipse
      </li><li><code class="literal">demo.setup.tomcat</code>: installs tomcat, installs jbpm into tomcat,
        starts tomcat, creates the jBPM DB schema, deploys examples, loads example identities,
        installs and starts eclipse
      </li><li><code class="literal">clean.cfg.dir</code>: Deletes the <code class="literal">${jbpm.home}/install/generated/cfg</code> folder.
      </li><li><code class="literal">create.cfg</code>: Creates a configuration in 
        <code class="literal">${jbpm.home}/install/generated/cfg</code> based on the current parameters.
      </li><li><code class="literal">create.jbpm.schema</code>: creates the jbpm tables in the database
      </li><li><code class="literal">create.user.webapp</code>: Generates a basic webapp in 
        <code class="literal">${jbpm.home}/install/generated/user-webapp</code></li><li><code class="literal">delete.jboss</code>: Deletes the JBoss installation
      </li><li><code class="literal">delete.tomcat</code>: Deletes the Tomcat installation
      </li><li><code class="literal">demo.teardown.jboss</code>: Drops the jbpm db schema and stops jboss
      </li><li><code class="literal">demo.teardown.tomcat</code>: Stops tomcat and then the hsqldb server (if needed)
      </li><li><code class="literal">drop.jbpm.schema</code>: Drops the jbpm tables from the database
      </li><li><code class="literal">get.eclipse</code>: Downloads eclipse if it is not available
      </li><li><code class="literal">get.jboss</code>: Downloads a JBoss AS which was tested against the current jBPM version if it is not available
      </li><li><code class="literal">get.tomcat</code>: Downloads tomcat which was tested against the current jBPM version if it is not available
      </li><li><code class="literal">hsqldb.databasemanager</code>: Starts the hsqldb database manager
      </li><li><code class="literal">install.eclipse</code>:  Unzips eclipse, downloads eclipse if it is not available
      </li><li><code class="literal">install.jboss</code>: Downloads JBoss if its not available and then unzips it
      </li><li><code class="literal">install.jbpm.into.jboss</code>: Installs jBPM into JBoss
      </li><li><code class="literal">install.tomcat</code>: Downloads tomcat to ${tomcat.distro.dir} if its not available and then unzips tomcat
      </li><li><code class="literal">install.jbpm.into.tomcat</code>: Installs jBPM into tomcat
      </li><li><code class="literal">install.examples.into.tomcat</code>: Deploys all the example processes
      </li><li><code class="literal">install.signavio.into.jboss</code>: Installs signavio into jboss
      </li><li><code class="literal">install.signavio.into.tomcat</code>: Installs signavio into tomcat
     </li><li><code class="literal">load.example.identities</code>: Loads the example users and groups into the database
      </li><li><code class="literal">reinstall.jboss</code>: Deletes the previous jboss installation and re-installs jboss
      </li><li><code class="literal">reinstall.jboss.and.jbpm</code>: Deletes the previous jboss installation and re-installs jboss and installs jbpm in it
      </li><li><code class="literal">reinstall.tomcat</code>: Deletes the previous tomcat installation and re-installs tomcat
      </li><li><code class="literal">reinstall.tomcat.and.jbpm</code>: Deletes the previous tomcat installation and re-installs tomcat and installs jbpm in it
      </li><li><code class="literal">start.eclipse</code>: Starts eclipse
      </li><li><code class="literal">start.jboss</code>: Starts jboss and waits till jboss is booted, then lets jboss run in the background
      </li><li><code class="literal">start.tomcat</code>: Starts Tomcat and waits till it is booted, then lets Tomcat run in the background
      </li><li><code class="literal">stop.jboss</code>: signals jboss to stop, but doesn't wait till its finished
      </li><li><code class="literal">stop.tomcat</code>: Signals Tomcat to stop, but doesn't wait till its finished
      </li><li><code class="literal">upgrade.jbpm.schema</code>:  Upgrades the jBPM tables in the database to the current version
      </li></ul></div><p>
    </p><p>To specify your jdbc properties that are used in the scripts above (eg.DB schema generation), 
    the easiest is to update the appropriate properties file in directory <code class="literal">${jbpm.home}/install/jdbc</code>.  
    The appropriate properties file will be loaded by the scripts that are DB related. 
    </p><p>Also following properties are customizeable</p><div class="itemizedlist"><ul><li><code class="literal">database</code> : Default value is <code class="literal">hsqldb</code>.  Alternative values 
      are <code class="literal">mysql</code>, <code class="literal">oracle</code> and <code class="literal">postgresql</code></li><li><code class="literal">jboss.version</code> : Default value is <code class="literal">5.0.0.GA</code>.  Alternative 
      value is <code class="literal">5.1.0.GA</code></li></ul></div><p>To customize the values for these properties, just use <code class="literal">-D</code> like this
    </p><pre class="programlisting">ant -Ddatabase=postgresql demo.setup.jboss</pre><p>Alternatively you can specify the customized values in 
    <code class="literal">${user.home}/.jbpm4/build.properties</code> 
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="librarydependenciesandconfigurationfiles"/>2.5. Library dependencies and configuration files</h2></div></div></div><p>We provide support for installations of jBPM through our automatic ant  
    scripts.  Those scripts will put the right libs and the right configuration 
    files in the right location for you. If you want to create your own installation of 
    jBPM in your application, see the developers guide for more information.      
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="jboss"/>2.6. JBoss</h2></div></div></div><p>The target <code class="literal">install.jbpm.into.jboss</code> will install jBPM into
    your JBoss 5 installation.  Navigate to the install directory and run <code class="literal">ant -p</code>
    for more details.  This install script will install jBPM as a JBoss-wide service so 
    that all applications can use the same jBPM ProcessEngine. 
    </p><p>Specify property <code class="literal">-Djboss.home=PathToYourJBossInstallation</code> 
    to customize the path to your JBoss installation.
    </p><p>In JBoss, the <code class="literal">ProcessEngine</code> can be obtained from JNDI 
    with <code class="literal">new InitialContext().lookup("java:/ProcessEngine")</code>.
    The same ProcessEngine can be obtained with <code class="literal">Configuration.getProcessEngine()</code>
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="tomcat"/>2.7. Tomcat</h2></div></div></div><p>The target <code class="literal">install.jbpm.into.tomcat</code> will install jBPM into
    your JBoss 5 installation. 
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="signavio"/>2.8. Signavio web based process editor</h2></div></div></div><p>The targets <code class="literal">install.signavio.into.jboss</code> and 
    <code class="literal">install.signavio.into.tomcat</code> will install the Signavio web based 
    process editor into JBoss or Tomcat respectively. 
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="userwebapp"/>2.9. User webapp</h2></div></div></div><p>If you want to deploy jBPM as a part of your web application, use the
    install target <code class="literal">create.user.webapp</code>.  That will 
    create a web application with jBPM in it, in the location <code class="literal">${jbpm.home}/install/generated/user-webapp</code>.  
    </p><p>In case you deploy your app on JBoss or another appserver that has the 
    jta.jar classes, then you need to delete the <code class="literal">${jbpm.home}/install/generated/user-webapp/WEB-INF/lib/jta.jar</code> 
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="database"/>2.10. Database</h2></div></div></div><p>The install script is also capable of performing database operations
    such as creating the schema, if you are installing jBPM for the first time,
    or upgrading the database used with a previous version to the current schema.
    Dropping the schema is an option as well.
    </p><p>The prerrequisite for any database operation is to specify your
    database connection parameters in <code class="literal">${jbpm.home}/install/jdbc</code>.
    </p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="createdropdb"/>2.10.1. Creating or dropping the database schema</h3></div></div></div><p>To create the schema, run target <code class="literal">create.jbpm.schema</code>
      in the <code class="literal">${jbpm.home}/install</code> directory. Apart from
      creating tables and constraints, the mentioned target will initialize
      table <code class="literal">JBPM4_PROPERTY</code> with the current engine version
      (key <code class="literal">db.version</code>) and the ID generator base value
      (key <code class="literal">next.dbid</code>).</p><p>To drop the schema, simply run target <code class="literal">drop.jbpm.schema</code>.
      Be aware that this operation will destroy any data present in the jBPM
      tables.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="upgradedb"/>2.10.2. Upgrading an existing database</h3></div></div></div><p>To upgrade, run target <code class="literal">upgrade.jbpm.schema</code>
      in the <code class="literal">${jbpm.home}/install</code> directory.</p><p>Upgrading is a two-fold operation. The foremost step is to add
      any extra tables, columns or constraints that were introduced in newer
      versions. Afterwards, seed data is inserted.</p><p>Between 4.0 and 4.1, table <code class="literal">JBPM4_VARIABLE</code> got
      a new column <code class="literal">CLASSNAME_</code> used to support setting
      process variables to values of custom types mapped with Hibernate.
      This column is nullable and left uninitialized since the feature was
      not operational in 4.0.</p><p>From 4.1 to 4.2 the upgrade procedure got more interesting.</p><div class="itemizedlist"><ul><li>A new table <code class="literal">JBPM4_PROPERTY</code>
        was introduced for storing engine-wide values.</li><li>The jBPM version is saved in table <code class="literal">JBPM4_PROPERTY</code>
        under key <code class="literal">db.version</code> to allow for precise
        identification in future releases.</li><li>The ID generation strategy is consistent across databases.
        The next available ID is calculated by querying all tables having
        an identifier column, and stored under key <code class="literal">next.dbid</code>
        in the <code class="literal">JBPM4_PROPERTY</code> table.</li><li>The process language is set to <code class="literal">jpdl-4.0</code>
        for all existing process definitions under key <code class="literal">langid</code>
        in table <code class="literal">JBPM4_DEPLOYPROP</code>. The jPDL parser employs the
        <code class="literal">langid</code> property to read process documents in a
        backwards-compatible manner.</li></ul></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="graphicalprocessdesigner"/>2.11. Graphical Process Designer (GPD)</h2></div></div></div><p>Eclipse is used as the platform to host the jPDL graphical process
    designer. This section will describe how to obtain and install Eclipse and 
    how to install the GPD plugin in Eclipse.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e645"/>2.11.1. Get Eclipse</h3></div></div></div><p>You'll need Eclipse 3.5.0.
      </p><p>Use the <a href="#gettingstartedquickly" title="2.3. Getting started quickly">demo setup</a> or download 
      eclipse manually:      
      <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://www.eclipse.org/downloads/download.php?file=/technology/epp/downloads/release/galileo">Eclipse IDE for Java EE Developers (163 MB)</a>.
      </p><p>The classic version of eclipse will not be sufficient as it does 
      not have an XML editor.  Eclipse for Java developers should also 
      work.
      </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e660"/>2.11.2. Install the GPD plugin into eclipse</h3></div></div></div><p>The installation of the GPD uses the Eclipse Software Update 
      mechanism and is pretty straightforward. There is an archived update 
      site included in the runtime installation of jBPM when you unzip it 
      at <code class="literal">install/src/gpd/jbpm-gpd-site.zip</code> 
      </p><p>To add the update site to eclipse:
      </p><div class="itemizedlist"><ul><li><code class="literal">Help</code> --&gt; <code class="literal">Install New Software...</code></li><li>Click <code class="literal">Add...</code></li><li>In dialog <code class="literal">Add Site</code> dialog, click <code class="literal">Archive...</code></li><li>Navigate to <code class="literal">install/src/gpd/jbpm-gpd-site.zip</code> and click 'Open'</li><li>Clicking <code class="literal">OK</code> in the <code class="literal">Add Site</code> dialog will bring you back to the dialog 'Install'</li><li>Select the <code class="literal">jPDL 4 GPD Update Site</code> that has appeared</li><li>Click <code class="literal">Next...</code> and then <code class="literal">Finish</code></li><li>Approve the license</li><li>Restart eclipse when that is asked</li></ul></div><div class="figure"><a id="gpd.install.gpd.site"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.install.gpd.site.png" align="middle" alt="Adding the GPD local archive site"/></div></div><p class="title"><b>Figure 2.1. Adding the GPD local archive site</b></p></div><br class="figure-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e723"/>2.11.3. Configuring the jBPM runtime</h3></div></div></div><div class="itemizedlist"><ul><li>Click <code class="literal">Window</code> --&gt; <code class="literal">Preferences</code></li><li>Select <code class="literal">JBoss jBPM</code> --&gt; <code class="literal">jBPM 4</code> --&gt; <code class="literal">Runtime Locations</code></li><li>Click <code class="literal">Add...</code></li><li>In the <code class="literal">Add Location</code> dialog, enter a name like e.g. <code class="literal">jbpm-4.0</code> and then click <code class="literal">Search...</code></li><li>In the <code class="literal">Browse For Folder</code> dialog, select your jbpm home directory and click <code class="literal">OK</code></li><li>Click <code class="literal">OK</code> in the <code class="literal">Add Location</code> dialog</li></ul></div><div class="figure"><a id="gpd.runtime.location"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.runtime.location.png" align="middle" alt="Defining jBPM Libraries"/></div></div><p class="title"><b>Figure 2.2. Defining jBPM Libraries</b></p></div><br class="figure-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="definejbpmuserlibraries"/>2.11.4. Define the jBPM User Library</h3></div></div></div><p>This section shows how to define a user library for your workspace
      that is a placeholder for the jBPM library as well as its dependencies. 
      If you create a new Java project, it will be sufficient to add this user 
      library to the build path.
      </p><div class="itemizedlist"><ul><li>Click <code class="literal">Window</code> --&gt; <code class="literal">Preferences</code></li><li>Select <code class="literal">Java</code> --&gt; <code class="literal">Build Path</code> --&gt; <code class="literal">User Libraries</code></li><li>Click <code class="literal">New...</code></li><li>Type name <code class="literal">jBPM Libraries</code></li><li>Click <code class="literal">Add JARs...</code></li><li>Navigate to the 'lib' folder of your jBPM installation</li><li>Select all jar files and click <code class="literal">Open</code></li><li>Select the <code class="literal">jBPM Libraries</code> entry</li><li>Click <code class="literal">Add JARs...</code> again</li><li>Select the <code class="literal">jbpm.jar</code> file in the root of your jBPM installation</li><li>Click <code class="literal">Open</code></li><li>Select entry <code class="literal">Source attachment</code> under <code class="literal">jbpm.jar</code></li><li>Click <code class="literal">Edit</code></li><li>In dialog <code class="literal">Source Attachment Configuration</code>, click <code class="literal">External Folder...</code></li><li>Navigate to the <code class="literal">src</code> folder in your jBPM installation</li><li>Click <code class="literal">Choose</code></li><li>Click <code class="literal">OK</code> twice to close all the open dialogs</li></ul></div><div class="figure"><a id="gpd.install.libraries"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.install.libraries.png" align="middle" alt="Defining jBPM Libraries"/></div></div><p class="title"><b>Figure 2.3. Defining jBPM Libraries</b></p></div><br class="figure-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e877"/>2.11.5. Adding jPDL 4 schema to the catalog</h3></div></div></div><p>In case you want to edit the process XML sources directly, it is best to specify 
      your schema in the XML catalog.  This will give you better code completion while 
      editing the process sources.
      </p><div class="itemizedlist"><ul><li>Click <code class="literal">Window</code> --&gt; <code class="literal">Preferences</code></li><li>Select <code class="literal">XML</code> --&gt; <code class="literal">XML Catalog</code></li><li>Click 'Add...'</li><li>The 'Add XML Catalog Entry' dialog opens</li><li>Click the button with the map-icon next to location and select 'File System...'</li><li>In the dialog that opens, select file <code class="literal">jpdl-4.0.xsd</code> 
        in the src directory of the jBPM installation root.</li><li>Click 'Open' and close all the dialogs</li></ul></div><div class="figure"><a id="gpd.install.xml.catalog"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.install.xml.catalog.png" align="middle" alt="Adding jPDL 4 schema to the Catalog"/></div></div><p class="title"><b>Figure 2.4. Adding jPDL 4 schema to the Catalog</b></p></div><br class="figure-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e916"/>2.11.6. Importing the Examples</h3></div></div></div><p>In this section we will import the examples project in the 
      installation in Eclipse
      </p><div class="itemizedlist"><ul><li>Select <code class="literal">File</code> --&gt; <code class="literal">Import...</code></li><li>Select <code class="literal">General</code> --&gt; <code class="literal">Existing Projects into Workspace</code></li><li>Click <code class="literal">Next</code></li><li>Click <code class="literal">Browse...</code> to select a root directory</li><li>Navigate to the jBPM root installation directory</li><li>Click <code class="literal">OK</code></li><li>The <code class="literal">examples</code> project is automatically found and selected</li><li>Click <code class="literal">Finish</code></li></ul></div><p>After setting the <a href="#definejbpmuserlibraries" title="2.11.4. Define the jBPM User Library">jBPM User Libraries</a> 
      and importing the examples, all the examples can be run as JUnit tests.  Right click 
      on a test and select 'Run As' --&gt; 'JUnit Test'.  
      </p><p>You're all set to start playing with the coolest Java process technology!</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e967"/>2.11.7. Adding deployment with ant</h3></div></div></div><p>You can leverage the eclipse ant integration to ease deployment of processes.
      We'll show you how it works with the examples.  Then you can copy this practice in your 
      own project.  First, open up the Ant view.  
      </p><div class="itemizedlist"><ul><li>Select <code class="literal">Window</code> --&gt; <code class="literal">Show View</code> --&gt; <code class="literal">Other...</code> --&gt; <code class="literal">Ant</code> --&gt; <code class="literal">Ant</code></li><li>Then drag the build file <code class="literal">build.xml</code> in the examples project from the package explorer to the Ant view</li></ul></div></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="graphicalprocessdesigner"/>Chapter 3. Graphical Process Designer (GPD)</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#creatingnewprocessfile">3.1. Creating a new process file</a></span></dt><dt><span class="section"><a href="#editingtheprocesssource">3.2. Editing the process source</a></span></dt></dl></div><p>This chapter will explain how to work with the Graphical Process Designer. 
  After installing the GPD and setting up the examples, you'll see that the 
  jPDL process files will get a special icon.  Double clicking such a file 
  in the package view will open up the jPDL process in the GPD.
  </p><div class="figure"><a id="gpd"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.png" align="middle" alt="The GPD"/></div></div><p class="title"><b>Figure 3.1. The GPD</b></p></div><br class="figure-break"/><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="creatingnewprocessfile"/>3.1. Creating a new process file</h2></div></div></div><p>CRTL+N will open up the wizard selector.
    </p><div class="figure"><a id="gpd.new.process.wizard"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.new.process.wizard.png" align="middle" alt="Select wizard dialog"/></div></div><p class="title"><b>Figure 3.2. Select wizard dialog</b></p></div><br class="figure-break"/><p>Select jBPM --&gt; jPDL 4 File.  Click 'Next &gt;'.  Then the 
    'New jPDL 4 File' wizard opens.  
    </p><div class="figure"><a id="gpd.new.process.file"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.new.process.file.png" align="middle" alt="Create a new process dialog"/></div></div><p class="title"><b>Figure 3.3. Create a new process dialog</b></p></div><br class="figure-break"/><p>Select the parent directory, enter a file name and click 'Finish'.  Voila, 
    you've created your first jPDL process file.
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="editingtheprocesssource"/>3.2. Editing the process source</h2></div></div></div><p>The GPD contains a 'Source' tab with the XML sources. These are directly editable in
    this tab and the graphical view will reflect the changes when you switch back to the diagram.</p><div class="figure"><a id="gpd.source.tab"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/gpd.xml.view.png" align="middle" alt="Editing jPDL using the source view"/></div></div><p class="title"><b>Figure 3.4. Editing jPDL using the source view</b></p></div><br class="figure-break"/></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="deployingbusinessarchives"/>Chapter 4. Deploying business archives</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#deployingprocessfilesandprocessresources">4.1. Deploying process files and process resources</a></span></dt><dt><span class="section"><a href="#deployingclasses">4.2. Deploying classes</a></span></dt></dl></div><p>A business archive is a collection of files 
  assembled in a jar formatted file.  The files in 
  a business archive can be jPDL process files, forms,
  classes, process image and other process resources.
  </p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="deployingprocessfilesandprocessresources"/>4.1. Deploying process files and process resources</h2></div></div></div><p>Process files and process resources have to be 
    deployed in the process repository which is stored in 
    the database.
    </p><p>There is a jBPM ant task to deploy business archives
    (<code class="literal">org.jbpm.pvm.internal.ant.JbpmDeployTask</code>).
    The <code class="literal">JbpmDeployTask</code> can deploy individual  
    process files and business archives.  They are deployed  
    directly to the database over a JDBC connection.  So it is a 
    requirement that the database is up and running before you can 
    deploy processes. 
    </p><p>An example of creating and deploying a business 
    archive can be found in the ant build script (build.xml) in the examples directory of the 
    distribution.  Let's look at the relevant parts.  First a path is 
    declared that includes the jbpm.jar and all its dependencies.  
    </p><pre class="programlisting">&lt;path id="jbpm.libs.incl.dependencies"&gt;
  &lt;pathelement location="${jbpm.home}/examples/target/classes" /&gt;
  &lt;fileset dir="${jbpm.home}"&gt;
    &lt;include name="jbpm.jar" /&gt;
  &lt;/fileset&gt;
  &lt;fileset dir="${jbpm.home}/lib" /&gt;
&lt;/path&gt;</pre><p>The JDBC driver jar(s) for your database should also be included
    in the path.  MySQL, PostgreSQL and HSQLDB are in the distribution.  But
    the Oracle driver you have to download separately from the oracle site since 
    we're not allowed to redistribute that file. 
    </p><p>When a business archive is deployed, jBPM scans for all the files 
    with the <code class="literal">.jpdl.xml</code> extension in the business archive.
    All those files will be parsed as jPDL processes and made available to the
    runtime engine.  All other resources in the business archive will also 
    be stored as resources in that deployment and made accessible through
    <code class="literal">InputStream getResourceAsStream(long deploymentDbid, String resourceName);</code>
    in class <code class="literal">RepositoryService</code> 
    </p><p>For creating a business archives, the <code class="literal">jar</code> task
    can be used.
    </p><pre class="programlisting">&lt;jar destfile="${jbpm.home}/examples/target/examples.bar"&gt;
  &lt;fileset dir="${jbpm.home}/examples/src"&gt;
    &lt;include name="**/*.jpdl.xml" /&gt;
    ...
  &lt;/fileset&gt;
&lt;/jar&gt;</pre><p>Before the jbpm-deploy task can be used it need to be declared like this:</p><pre class="programlisting">&lt;taskdef name="jbpm-deploy"
    classname="org.jbpm.pvm.internal.ant.JbpmDeployTask"
    classpathref="jbpm.libs.incl.dependencies" /&gt;</pre><p>Then the ant task can be used like this</p><pre class="programlisting">&lt;jbpm-deploy file="${jbpm.home}/examples/target/examples.bar" /&gt;</pre><div class="table"><a id="d0e1087"/><p class="title"><b>Table 4.1. <code class="literal">jbpm-deploy</code> attributes:</b></p><div class="table-contents"><table summary="jbpm-deploy attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">file</code></td><td>file</td><td> </td><td>optional</td><td>A file to be deployed.  Files ending with <code class="literal">.xml</code> will be deployed 
            as process files.  Files ending with <code class="literal">ar</code> like .bar or .jar 
            will be deployed as business archives.
            </td></tr><tr><td><code class="literal">cfg</code></td><td>file</td><td>jbpm.cfg.xml</td><td>optional</td><td>Points to the jbpm configuration file that has to be on the classpath in which 
            the <code class="literal">jbpm-deploy</code> task was defined.
            </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e1138"/><p class="title"><b>Table 4.2. <code class="literal">jbpm-deploy</code> elements:</b></p><div class="table-contents"><table summary="jbpm-deploy elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">fileset</code></td><td>0..*</td><td>files to be deployed expressed as a plain ant fileset.
            Files ending with <code class="literal">.xml</code> will be deployed 
            as process files.  Files ending with <code class="literal">ar</code> like .bar or .jar 
            will be deployed as business archives.</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="deployingclasses"/>4.2. Deploying classes</h2></div></div></div><p>Since version 4.2 jBPM has a process classloading mechanism as in jBPM 3.
    </p><p>Classes that are referenced from processes must be made available in one of 
    3 ways:
    </p><div class="itemizedlist"><ul><li>as .class files in your business archive.  Unlike in jBPM 3, now the
      root of the archive file is used as the root for searching class resources.
      So when class <code class="literal">com.superdeluxsandwiches.Order</code>
      is referenced in the process file, it will be found when it is in the same business 
      archive with entry name <code class="literal">com/superdeluxsandwiches/Order.class</code>
      Classes are cached (key is a combination of deployment and context classloader), so 
      it should perform better then in jBPM 3. 
      </li><li>as classes available in the web application that calls jBPM.  Even when 
      jBPM is deployed server-wide on jboss or tomcat, jBPM will find the classes 
      in your web application or enterprise application that calls jBPM.  That's because 
      we use the current context classloader when searching for classes during process 
      execution. 
      </li><li>as class files that are available server-wide.  E.g. like the jars in  
      the lib directories in tomcat and jboss.
      </li></ul></div><p>In case of the examples, an examples.jar file is created with 
    all the classes and it is put in the <code class="literal">lib</code> directory of the JBoss 
    server configuration.  Similarly for tomcat.  See target <code class="literal">install.examples.into.tomcat</code>
    and <code class="literal">install.examples.into.jboss</code>.  In one of the future releases we might 
    switch to include the classes in the business archive itself.
    </p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="services"/>Chapter 5. Services</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#processdefinitionprocessinstanceandexecutions">5.1. Process definition, process instance and executions</a></span></dt><dt><span class="section"><a href="#processengine">5.2. ProcessEngine</a></span></dt><dt><span class="section"><a href="#deployingaprocess">5.3. Deploying a process</a></span></dt><dt><span class="section"><a href="#deletingadeployment">5.4. Deleting a deployment</a></span></dt><dt><span class="section"><a href="#startinganewprocessinstance">5.5. Starting a new process instance</a></span></dt><dd><dl><dt><span class="section"><a href="#inlatest">5.5.1. In latest</a></span></dt><dt><span class="section"><a href="#specificprocessversion">5.5.2. Specific process version</a></span></dt><dt><span class="section"><a href="#withakey">5.5.3. With a key</a></span></dt><dt><span class="section"><a href="#withvariables">5.5.4. With variables</a></span></dt></dl></dd><dt><span class="section"><a href="#singallingawaitingexecution">5.6. Signalling a waiting execution</a></span></dt><dt><span class="section"><a href="#taskservice">5.7. TaskService</a></span></dt><dt><span class="section"><a href="#historyservice">5.8. HistoryService</a></span></dt><dt><span class="section"><a href="#managementservice">5.9. ManagementService</a></span></dt><dt><span class="section"><a href="#queryApi">5.10. Query API</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="processdefinitionprocessinstanceandexecutions"/>5.1. Process definition, process instance and executions</h2></div></div></div><p>A process definition is description of the steps in a procedure.
    For example, an insurance company could have a <code class="literal">loan</code> 
    process definition that describes the steps of how the company deals 
    with loan requests.
    </p><div class="figure"><a id="loan.process.definition.example"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/loan.process.definition.png" align="middle" alt="The loan process definition example"/></div></div><p class="title"><b>Figure 5.1. The loan process definition example</b></p></div><br class="figure-break"/><p>One process instance represents one particular run of a process definition.
    For example, the loan request of John Doe last Friday to finance his new boat 
    is represented in one process instance of the loan process definition.
    </p><p>A process instance contains all the runtime state.  The 
    most prominent property is the pointer that keeps track of the current activity.
    </p><div class="figure"><a id="loan.process.instance.example"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/loan.process.instance.png" align="middle" alt="The loan process instance example"/></div></div><p class="title"><b>Figure 5.2. The loan process instance example</b></p></div><br class="figure-break"/><p>Suppose that wiring the money and archiving can be done in parallel.
    Then the main process instance will have two child executions to keep 
    track of the state like this:   
    </p><div class="figure"><a id="loan.executions.example"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/loan.executions.png" align="middle" alt="The loan executions example"/></div></div><p class="title"><b>Figure 5.3. The loan executions example</b></p></div><br class="figure-break"/><p>More general, a process instance is the root of a tree of executions.
    When a new process instance is started, the process instance is in fact the root 
    execution scope.  Only leaf executions can be active.
    </p><p>The motivation to work with a tree structure like this is that
    this conceptually remains simple in the case where there is only one path 
    of execution.  The services API doesn't need to make a functional difference 
    between process instances and executions.  Therefore, the API has only 
    one Execution type to refer to both <code class="literal">ProcessInstance</code>s and 
    <code class="literal">Execution</code>s. 
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="processengine"/>5.2. ProcessEngine</h2></div></div></div><p>Interacting with jBPM occurs through services.
    The service interfaces can be obtained from the <code class="literal">ProcessEngine</code>
    which is build from a <code class="literal">Configuration</code>.  
    </p><p>A <code class="literal">ProcessEngine</code> is thread safe and can be stored in a 
    static member field or even better in JNDI or some other central location.  
    One <code class="literal">ProcessEngine</code> object can be used by all requests and 
    threads in an application.  Here's how you can obtain a <code class="literal">ProcessEngine</code>
    </p><p>The code snippets in this section and the next section about process 
    deployments are taken from the example 
    <code class="literal">org.jbpm.examples.services.ServicesTest</code> 
    </p><pre class="programlisting">ProcessEngine processEngine = new Configuration()
      .buildProcessEngine();</pre><p>The previous code snippet shows how to build a <code class="literal">ProcessEngine</code>
    from the default configuration file <code class="literal">jbpm.cfg.xml</code> which is 
    expected in the root of the classpath.  If you want to specify another 
    resource location, use the <code class="literal">setResource</code> method like this: 
    </p><pre class="programlisting">ProcessEngine processEngine = new Configuration()
      .setResource("my-own-configuration-file.xml")
      .buildProcessEngine();</pre><p>There are other <code class="literal">setXxxx</code> methods that allow to specify 
    the configuration content as an <code class="literal">InputStream</code>, an 
    <code class="literal">xmlString</code>, <code class="literal">InputSource</code>, 
    <code class="literal">URL</code> or  <code class="literal">File</code>.  
    </p><p>From a <code class="literal">ProcessEngine</code> the following services 
    can be obtained:
    </p><pre class="programlisting"><span class="bold"><strong>RepositoryService</strong></span> repositoryService = processEngine.getRepositoryService();
<span class="bold"><strong>ExecutionService</strong></span> executionService = processEngine.getExecutionService();
<span class="bold"><strong>TaskService</strong></span> taskService = processEngine.getTaskService();
<span class="bold"><strong>HistoryService</strong></span> historyService = processEngine.getHistoryService();
<span class="bold"><strong>ManagementService</strong></span> managementService = processEngine.getManagementService();</pre><p>Process engine objects defined in the configuration can also be retrieved by 
    type (<code class="literal">processEngine.get(Class&lt;T&gt;)</code>) 
    or by name (<code class="literal">processEngine.get(String)</code>)</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="deployingaprocess"/>5.3. Deploying a process</h2></div></div></div><p>The <code class="literal">RepositoryService</code> groups all methods to manage 
    the repository of deployments.  In this first example, we'll deploy one process 
    resource from the classpath with the <code class="literal">RepositoryService</code>:
    </p><pre class="programlisting">String deploymentId = repositoryService.createDeployment()
    .addResourceFromClasspath("org/jbpm/examples/services/Order.jpdl.xml")
    .deploy();</pre><p>Analogue to the <code class="literal">addResourceFromClasspath</code> method above, 
    the source of the processes definitions XML can be picked up from a file, url, string, 
    input stream or zip input stream.
    </p><p>Each deployment is composed of a set of named resources.  The content 
    of each resource is a byte array.  jPDL process files are recognized by their extension 
    <code class="literal">.jpdl.xml</code>.  Other resource types are task forms and java classes.  
    </p><p>A deployment works with a set of named resources and can potentially contain 
    multiple process descriptions and multiple other artifact types.  The jPDL deployer 
    will recognise process files based on the <code class="literal">.jpdl.xml</code> 
    extension automatically.  
    </p><p>During deployment, an <code class="literal">id</code> is assigned to the process 
    definitions.  The <code class="literal">id</code> will have format 
    <code class="literal">{key}-{version}</code> with a dash between key and version
    </p><p>If <code class="literal">key</code> is not provided, it is generated automatically 
    based on the name.  All non alpha numeric characters in the name will be replaced 
    by underscores to generate the key.
    </p><p>The same <code class="literal">name</code> can only be associated to one 
    <code class="literal">key</code> and vice versa.
    </p><p>If <code class="literal">version</code> is not provided, a <code class="literal">version</code> 
    will be automatically be assigned.  For version 
    assignment, the versions of all deployed process definitions with the same name will 
    be taken into account.  The assigned <code class="literal">version</code> will be one higher 
    than the highest <code class="literal">version</code> number of deployed process definitions 
    with the same <code class="literal">key</code>.  If no process definitions with a similar
    <code class="literal">key</code> have been deployed, version number 1 is assigned. 
    </p><p>In this first example, we'll supply a name and nothing else.</p><pre class="programlisting">&lt;process name="Insurance claim"&gt;
...
&lt;/process&gt;</pre><p>Let's assume that this is the first time that this process gets deployed.
    Then it will get the following properties:
    </p><div class="table"><a id="d0e1412"/><p class="title"><b>Table 5.1. Process properties without key</b></p><div class="table-contents"><table summary="Process properties without key" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Property</th><th>Value</th><th>Source</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>Insurance claim</td><td>process xml</td></tr><tr><td><code class="literal">key</code></td><td>Insurance_claim</td><td>generated</td></tr><tr><td><code class="literal">version</code></td><td>1</td><td>generated</td></tr><tr><td><code class="literal">id</code></td><td>Insurance_claim-1</td><td>generated</td></tr></tbody></table></div></div><br class="table-break"/><p>And as a second example, we'll show how you can get shorter ids by 
    specifying a process key:</p><pre class="programlisting">&lt;process name="Insurance claim" key="ICL"&gt;
...
&lt;/process&gt;</pre><p>Then the process definition properties look like this:</p><div class="table"><a id="d0e1463"/><p class="title"><b>Table 5.2. Process properties with key</b></p><div class="table-contents"><table summary="Process properties with key" border="1"><colgroup><col/><col/></colgroup><thead><tr><th>Property</th><th>Value</th><th>Source</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>Insurance claim</td><td>process xml</td></tr><tr><td><code class="literal">key</code></td><td>ICL</td><td>process xml</td></tr><tr><td><code class="literal">version</code></td><td>1</td><td>generated</td></tr><tr><td><code class="literal">id</code></td><td>ICL-1</td><td>generated</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="deletingadeployment"/>5.4. Deleting a deployment</h2></div></div></div><p>Deleting a deployment will remove it from the DB.</p><pre class="programlisting">repositoryService.deleteDeployment(deploymentId);</pre><p>That method will throw an exception when there are still active 
    process executions for process definitions in that deployment.
    </p><p>If you want to cascade deletion of a deployment to all 
    the process instances of all the process definitions, use
    <code class="literal">deleteDeploymentCascade</code>.
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="startinganewprocessinstance"/>5.5. Starting a new process instance</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="inlatest"/>5.5.1. In latest</h3></div></div></div><p>Simplest and most common way to start a new process instance for a process 
      definition is like this: 
      </p><pre class="programlisting">ProcessInstance processInstance = executionService.startProcessInstanceByKey("ICL");</pre><p>In this case, the service method will first look up the latest version of 
      the processes with key <code class="literal">ICL</code>.  Then a new 
      process instance is started in that latest process definition.
      </p><p>When a new version of the insurance claim process 
      is deployed, all invocations of <code class="literal">startProcessInstanceByKey</code>
      will automatically switch to the newly deployed version.
      </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="specificprocessversion"/>5.5.2. Specific process version</h3></div></div></div><p>If instead you want to start a new process instance in a very 
      specific version, you can use the id of the process definition like this:
      </p><pre class="programlisting">ProcessInstance processInstance = 
    executionService.startProcessInstanceById("ICL-1");</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="withakey"/>5.5.3. With a key</h3></div></div></div><p>A new process instance can optionally be given a key.  This key is 
      a user defined reference to the execution and is sometimes referred to as
      the 'business key'.  A business key must be unique within the 
      scope of all versions of a process definition. Typically it is easy 
      to find such a key in the domain of the business process. For example, an 
      order id or an insurance claim number.
      </p><pre class="programlisting">ProcessInstance processInstance = 
    executionService.startProcessInstanceByKey("ICL", "CL92837");</pre><p>The key is used to create the id of the process instance.  
      The format used is <code class="literal">{process-key}.{execution-id}</code>.  
      With a dot between process-key and execution-id. 
      So execution created in the previous code snippet will have id 
      <code class="literal">ICL.CL92837</code>.
      </p><p>If no user defined key is provided, the DB primary key is taken
      as the key.  In that case, the id can be retrieved like this:   
      </p><pre class="programlisting">ProcessInstance processInstance = 
    executionService.startProcessInstanceByKey("ICL");
String pid = processInstance.getId();</pre><p>
      </p><p>It is a best practice to use a user defined business key. Typically in your application 
      domain, finding such a key is not difficult. By providing a user defined key, you can 
      then compose the id of the execution, rather then performing a query based 
      on the process variables - which is also more costly performance-wise.
      </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="withvariables"/>5.5.4. With variables</h3></div></div></div><p>A map of named parameter objects can be provided when starting a 
      new process instance.  These parameters will be set as variables on the process 
      instance between creation and start of the process instance.
      </p><pre class="programlisting">Map&lt;String,Object&gt; variables = new HashMap&lt;String,Object&gt;();
variables.put("customer", "John Doe");
variables.put("type", "Accident");
variables.put("amount", new Float(763.74));

ProcessInstance processInstance = 
    executionService.startProcessInstanceByKey("ICL", variables);</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="singallingawaitingexecution"/>5.6. Signalling a waiting execution</h2></div></div></div><p>When using a <code class="literal">state</code> activity, the execution (or process instance) 
    will halt when it arrives in a state, waiting for a signal (aka external trigger).  
    The method <code class="literal">signalExecution</code> and alike can be used for that.  Executions are 
    referenced by an execution id (String).
    </p><p>In some cases, the execution that arrives in a state will be the process instance 
    itself.  But that is not always the case.  In case of timers or concurrency, a process 
    is the root execution of a tree of executions.  So you have to make sure that you signal
    the right path of execution.
    </p><p>The preferred way to capture the right execution is by associating an event listener to 
    the state activity like this:
    </p><pre class="programlisting">&lt;state name="wait"&gt;
  &lt;on event="start"&gt;
    &lt;event-listener class="org.jbpm.examples.StartExternalWork" /&gt;
  &lt;/on&gt;
  ...
&lt;/state&gt;</pre><p>In event listener <code class="literal">StartExternalWork</code> you can kick off what needs to
    be done externally.  In that event listener you can also obtain the exact execution id
    with <code class="literal">execution.getId()</code>.  It's that executionId that you'll need to provide 
    with the signal later on when the external work is done:
    </p><pre class="programlisting">executionService.signalExecutionById(executionId);</pre><p>There is an alternatively (less preferrable) way to obtain the executionId 
    when the execution arrives in the <code class="literal">state</code> activity.  
    It's only possible to obtain the execution id this way if you know after which jBPM 
    API call the execution will have entered the <code class="literal">state</code> activity:
    </p><pre class="programlisting">// assume that we know that after the next call
// the process instance will arrive in <code class="literal">state</code> external work

ProcessInstance processInstance = 
  executionService.startProcessInstanceById(processDefinitionId);
// or ProcessInstance processInstance = 
//  executionService.signalProcessInstanceById(executionId);

Execution execution = processInstance.findActiveExecutionIn("external work");
String executionId = execution.getId();</pre></div><p>
  Do note that the above solution couples the application logic (too) closely
  by using knowledge about the actual process structure.
  </p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="taskservice"/>5.7. TaskService</h2></div></div></div><p>The primary purpose of the TaskService is to provide access to 
    task lists.  The code sample will show how to get the task list for 
    the user with id <code class="literal">johndoe</code>.  
    </p><pre class="programlisting">List&lt;Task&gt; taskList = taskService.findPersonalTasks("johndoe");</pre><p>Typically tasks are associated with a form and displayed in some user 
    interface.  The form needs to be able to read and write data related to the task.   
    </p><pre class="programlisting">// read task variables
Set&lt;String&gt; variableNames = taskService.getVariableNames(taskId);
variables = taskService.getVariables(taskId, variableNames);</pre><pre class="programlisting">// write task variables
variables = new HashMap&lt;String, Object&gt;();
variables.put("category", "small");
variables.put("lires", 923874893);
taskService.setVariables(taskId, variables);</pre><p>The taskService is also used to complete tasks</p><pre class="programlisting">
taskService.completeTask(taskId);
taskService.completeTask(taskId, variables);
taskService.completeTask(taskId, outcome);
taskService.completeTask(taskId, outcome, variables);
</pre><p>
    The API allows to provide a map of variables that will be added as process
    variables before the task is completed. It is also possible to provide
    an 'outcome', that will be used to determine which outgoing transition
    will be chosen. The logic is as follows:
    </p><p>
      <span class="bold"><strong>
      If a task has one outgoing transition without a name then:
      </strong></span>
	    </p><div class="itemizedlist"><ul><li>taskService.getOutcomes() returns a collection that includes one null value</li><li>taskService.completeTask(taskId) will take that outgoing transition</li><li>taskService.completeTask(taskId, null) will take that outgoing transition</li><li>taskService.completeTask(taskId, "anyvalue") will result in an exception</li></ul></div><p>
    </p><p>
      <span class="bold"><strong>
      If a task has one outgoing transition with a name then: 
      </strong></span>
      </p><div class="itemizedlist"><ul><li>taskService.getOutcomes() returns a collection that includes only the name of the transition</li><li>taskService.completeTask(taskId) will take the single outgoing transition</li><li>taskService.completeTask(taskId, null) will will result in an exception (as there is no transition without a name)</li><li>taskService.completeTask(taskId, "anyvalue") will result in an exception</li><li>taskService.completeTask(taskId, "myName") will take the transition with the given name</li></ul></div><p>
    </p><p>
      <span class="bold"><strong>
      If a task has multiple outgoing transitions. One transition has no a name and the other transition have a name:
      </strong></span>
      </p><div class="itemizedlist"><ul><li>taskService.getOutcomes() returns a collection that includes a null value and the names of the other transitions</li><li>taskService.completeTask(taskId) will take the transition without a name</li><li>taskService.completeTask(taskId, null) will take the transition without a name</li><li>taskService.completeTask(taskId, "anyvalue") will result in an exception</li><li>taskService.completeTask(taskId, "myName") will take the 'myName' transition</li></ul></div><p>
    </p><p>
      <span class="bold"><strong>
      If a task has multiple outgoing transitions and all of them are uniquely named, then:  
      </strong></span>
      </p><div class="itemizedlist"><ul><li>taskService.getOutcomes() returns a collection that includes all the names of all the transitions</li><li>taskService.completeTask(taskId) will result in an exception, since there is no transition without a name</li><li>taskService.completeTask(taskId, null) will result in an exception, since there is no unnamed transition</li><li>taskService.completeTask(taskId, "anyvalue") will result in an exception</li><li>taskService.completeTask(taskId, "myName") will take the 'myName' transition</li></ul></div><p>
    </p><p>Tasks can also be offered to a set of candidates.  Candidates can be 
    users or groups.  Users can take tasks for which they are a candidate.  Taking 
    a task means that this user will be set as the assignee.  After that, other users 
    will be blocked from taking the task.
    </p><p>People should not work on 
    a task unless they are assigned to that task.  The user interface should display 
    forms and allow users to complete tasks if they are assigned to it.
    For unassigned tasks for which the user is a candidate, the only action that 
    should be exposed is 'take'.      
    </p><p>More on tasks in <a href="#task" title="6.2.6. task">Section 6.2.6, “<code class="literal">task</code>”</a> </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="historyservice"/>5.8. HistoryService</h2></div></div></div><p>During runtime execution of process instances, events are generated.  And from 
    those events, history information on both running and completed process executions are 
    collected in the history tables.  The <code class="literal">HistoryService</code> provides 
    access to that information. 
    </p><p>Querying for all process instances for a specific process definition can be 
    done like this:</p><pre class="programlisting">List&lt;HistoryProcessInstance&gt; historyProcessInstances = historyService
  .createHistoryProcessInstanceQuery()
  .processDefinitionId("ICL-1")
  .orderAsc(HistoryProcessInstanceQuery.PROPERTY_STARTTIME)
  .list();</pre><p>Also individual activity executions are stored in the history information as 
    <code class="literal">HistoryActivityInstance</code>s.
    </p><pre class="programlisting">List&lt;HistoryActivityInstance&gt; histActInsts = historyService
    .createHistoryActivityInstanceQuery()
    .processDefinitionId("ICL-1")
    .activityName("a")
    .list();</pre><p>Convenience methods <code class="literal">avgDurationPerActivity</code> and 
    <code class="literal">choiceDistribution</code> are also available.  See javadocs for more 
    information on those methods.
    </p><p>Sometimes there is a need to get complete list of nodes executed for a given process instance. 
    Following query can be used to get list of all nodes executed:</p><pre class="programlisting">List&lt;HistoryActivityInstance&gt; histActInsts = historyService
    .createHistoryActivityInstanceQuery()
    .processInstanceId("ICL.12345")
    .list();</pre><p>Above query is a bit different then querying by execution id. Sometimes execution id is different than process instance id, for instance when an activity has a timer then 
    execution id will get additional suffix, which makes that node excluded from a result list while querying by execution id.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="managementservice"/>5.9. ManagementService</h2></div></div></div><p>The management service is mostly used to manage the jobs.  See javadocs for 
    more information.  This functionality is also exposed through the jBPM web console.
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="queryApi"/>5.10. Query API</h2></div></div></div><p>
    Starting from jBPM 4.0, a new API has been introuced with a query system that 
    covers most of the queries you can think of. Developers who need to write company-specific
    queries can of course still rely on Hibernate. But for most use cases,
    the query API will be more then suffice. 
    Queries can be written in a unified way on all major jBPM concepts: 
    Process Instances, Tasks, Deployments, Historical processes, etc.
    </p><p>
    For example:
    </p><pre class="programlisting">
List&lt;ProcessInstance&gt; results = executionService.createProcessInstanceQuery()
                                       .processDefinitionId("my_process_definition")
                                       .notSuspended()
                                       .page(0, 50)
                                       .list();
    </pre><p>
    This example returns all the process instances of the given process definition
    which are not suspended. The result is also paged, and the first page of 50
    results is given. 
    </p><p>Querying tasks is done in completely the same way:
    </p><pre class="programlisting">
List&lt;Task&gt; myTasks = taskService.createTaskQuery()
    .processInstanceId(piId)
    .assignee("John")
    .page(100, 120)
    .orderDesc(TaskQuery.PROPERTY_DUEDATE)
    .list();
</pre><p>
This query will give all the tasks for a given process instance assigned to John, 
paged of course, in a descending order based on the duedate. 
    </p><p>
    Every service has operations of creating such unified queries (eg. querying
    jobs through the <code class="literal">ManagementService</code>, querying completed
    process instances through the <code class="literal">HistoryService</code>. Do check
    the Javadoc of the services to learn everything about the query API.
    </p></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="jpdl"/>Chapter 6. jPDL</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#process">6.1. <code class="literal">process</code></a></span></dt><dt><span class="section"><a href="#controlflowactivities">6.2. Control flow activities</a></span></dt><dd><dl><dt><span class="section"><a href="#start">6.2.1. <code class="literal">start</code></a></span></dt><dt><span class="section"><a href="#state">6.2.2. <code class="literal">state</code></a></span></dt><dt><span class="section"><a href="#decision">6.2.3. <code class="literal">decision</code></a></span></dt><dt><span class="section"><a href="#concurrency">6.2.4. <code class="literal">concurrency</code></a></span></dt><dt><span class="section"><a href="#end">6.2.5. <code class="literal">end</code></a></span></dt><dt><span class="section"><a href="#task">6.2.6. <code class="literal">task</code></a></span></dt><dt><span class="section"><a href="#subprocess">6.2.7. <code class="literal">sub-process</code></a></span></dt><dt><span class="section"><a href="#custom">6.2.8. <code class="literal">custom</code></a></span></dt></dl></dd><dt><span class="section"><a href="#automaticactivities">6.3. Automatic activities</a></span></dt><dd><dl><dt><span class="section"><a href="#java">6.3.1. <code class="literal">java</code></a></span></dt><dt><span class="section"><a href="#script">6.3.2. <code class="literal">script</code></a></span></dt><dt><span class="section"><a href="#hql">6.3.3. <code class="literal">hql</code></a></span></dt><dt><span class="section"><a href="#sql">6.3.4. <code class="literal">sql</code></a></span></dt><dt><span class="section"><a href="#mail">6.3.5. <code class="literal">mail</code></a></span></dt></dl></dd><dt><span class="section"><a href="#commonactivitycontents">6.4. Common activity contents</a></span></dt><dt><span class="section"><a href="#events">6.5. Events</a></span></dt><dd><dl><dt><span class="section"><a href="#d0e4606">6.5.1. Event listener example</a></span></dt><dt><span class="section"><a href="#d0e4640">6.5.2. Event propagation</a></span></dt></dl></dd><dt><span class="section"><a href="#asynchronouscontinuations">6.6. Asynchronous continuations</a></span></dt><dd><dl><dt><span class="section"><a href="#asyncactivity">6.6.1. Async activity</a></span></dt><dt><span class="section"><a href="#asyncfork">6.6.2. Async fork</a></span></dt></dl></dd><dt><span class="section"><a href="#usercode">6.7. User code</a></span></dt><dd><dl><dt><span class="section"><a href="#usercodeconfiguration">6.7.1. User code configuration</a></span></dt><dt><span class="section"><a href="#usercodeclassloading">6.7.2. User code classloading</a></span></dt></dl></dd></dl></div><p>This chapter will explain the jPDL file format for describing
  process definitions. jPDL is the prominent process language of jBPM. The goal
  of jPDL is to be as concise and developer-friendly as possible, while offering
  every feature you'd expect from a BPM process language.
  </p><p>The jPDL schema file contains more attributes and elements then this
  documentation.  This part of the documentation explains the stable and supported part of jPDL.
  Experimental/not supported jPDL features can be found in the developers guide.
  </p><p>An example jPDL process file looks like this:
  </p><pre class="programlisting">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;process name="Purchase order" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="Verify supplier" /&gt;
  &lt;/start&gt;

  &lt;state name="Verify supplier"&gt;
    &lt;transition name="Supplier ok" to="Check supplier data" /&gt;
    &lt;transition name="Supplier not ok" to="Error" /&gt;
  &lt;/state&gt;

  &lt;decision name="Check supplier data"&gt;
    &lt;transition name="nok" to="Error" /&gt;
    &lt;transition name="ok" to="Completed" /&gt;
  &lt;/decision&gt;

  &lt;end name="Completed" /&gt;

  &lt;end name="Error" /&gt;

&lt;/process&gt;</pre><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="process"/>6.1. <code class="literal">process</code></h2></div></div></div><p>The top level element representing one process definition.
    </p><div class="table"><a id="d0e1795"/><p class="title"><b>Table 6.1. <code class="literal">process</code> attributes:</b></p><div class="table-contents"><table summary="process attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>any text</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>name or label of the process used to display to the process
            name in user interactions.
            </td></tr><tr><td><code class="literal">key</code></td><td>alpha numeric characters and underscores</td><td>if omitted, the key will be generated based on the name by replacing
            all non-alpha-numeric characters with underscores</td><td>optional</td><td>identification to distinct different process definitions.
            Multiple versions of a process with the same key can be deployed.
            The key:name combination must remain exactly the same for all
            deployed versions.
            </td></tr><tr><td><code class="literal">version</code></td><td>integer</td><td>one higher then highest version number starting with 1 if no other process
            is deployed with the same name/key.
            </td><td>optional</td><td>version number of this process</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e1850"/><p class="title"><b>Table 6.2. <code class="literal">process</code> elements:</b></p><div class="table-contents"><table summary="process elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">description</code></td><td>0..1</td><td>description text</td></tr><tr><td><a href="#">activities</a></td><td>1..*</td><td>a list of any activity type can be placed here.  At least
            one <code class="literal">start</code> activity must be present.
            </td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="controlflowactivities"/>6.2. Control flow activities</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="start"/>6.2.1. <code class="literal">start</code></h3></div></div></div><p>Indicates where an execution for this process starts.  Typically there is
      exactly one start activity in a process.  A process has to have at least one start
      activity.  A start activity must have exactly one outgoing transition and that transition
      is taken when a process execution starts.
      </p><p>Known limitation: for now, a process can not have more then
      one <code class="literal">start</code>.
      </p><div class="table"><a id="d0e1901"/><p class="title"><b>Table 6.3. <code class="literal">start</code> attributes:</b></p><div class="table-contents"><table summary="start attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>any text</td><td> </td><td>optional</td><td>name of the activity.  Since a start activity
              cannot have incoming transitions, the name is optional.
              </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e1931"/><p class="title"><b>Table 6.4. <code class="literal">start</code> elements:</b></p><div class="table-contents"><table summary="start elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">transition</code></td><td>1</td><td>the outgoing transition</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="state"/>6.2.2. <code class="literal">state</code></h3></div></div></div><p>A wait state.  Process execution will wait until an external trigger is
      provided through the API.  Apart from the <a href="#commonactivitycontents" title="6.4. Common activity contents">
      common activity content</a>, <code class="literal">state</code> doesn't have any extra
      attributes or elements.
      </p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="statesequence"/>6.2.2.1. <code class="literal">state</code> sequence</h4></div></div></div><p>Let's look at an example which shows states connected with transitions
        as a sequence</p><div class="figure"><a id="process.state.sequence"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.state.sequence.png" align="middle" alt="A sequence of states"/></div></div><p class="title"><b>Figure 6.1. A sequence of states</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="StateSequence" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="a" /&gt;
  &lt;/start&gt;

  &lt;state name="a"&gt;
    &lt;transition to="b" /&gt;
  &lt;/state&gt;

  &lt;state name="b"&gt;
    &lt;transition to="c" /&gt;
  &lt;/state&gt;

  &lt;state name="c" /&gt;

&lt;/process&gt;</pre><p>After you start an execution like this:</p><pre class="programlisting">ProcessInstance processInstance =
    executionService.startProcessInstanceByKey("StateSequence");</pre><p>the created process instance will be positioned in
        state <code class="literal">a</code>.  Providing an external trigger can
        be done with the <code class="literal">signalExecution</code> methods.</p><pre class="programlisting">Execution executionInA = processInstance.findActiveExecutionIn("a");
assertNotNull(executionInA);

processInstance = executionService.signalExecutionById(executionInA.getId());
Execution executionInB = processInstance.findActiveExecutionIn("b");
assertNotNull(executionInB);

processInstance = executionService.signalExecutionById(executionInB.getId());
Execution executionInC = processInstance.findActiveExecutionIn("c");
assertNotNull(executionInC);</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="statechoice"/>6.2.2.2. <code class="literal">state</code> choice</h4></div></div></div><p>In this second example with states, we'll show how you can use a
        <code class="literal">state</code> can be used to feed in an external choice of
        the path to take.
        </p><div class="figure"><a id="process.state.choice"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.state.choice.png" align="middle" alt="A choice between state"/></div></div><p class="title"><b>Figure 6.2. A choice between state</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="StateChoice" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="wait for response" /&gt;
  &lt;/start&gt;

  &lt;state name="wait for response"&gt;
    &lt;transition name="accept" to="submit document" /&gt;
    &lt;transition name="reject" to="try again" /&gt;
  &lt;/state&gt;

  &lt;state name="submit document" /&gt;

  &lt;state name="try again" /&gt;

&lt;/process&gt;</pre><p>Let's start a new process instance for this process definition:</p><pre class="programlisting">ProcessInstance processInstance = executionService
    .startProcessInstanceByKey("StateChoice");</pre><p>Now, the execution has arrived in the <code class="literal">wait for response</code>.
        The execution will wait there until an external trigger is given.  In case
        a <code class="literal">state</code> has multiple outgoing transitions, the signalName given
        in the external trigger will be matched against the name of the outgoing transition
        to take.  So when we provide signalName <code class="literal">accept</code> like this:
        </p><pre class="programlisting">String executionId = processInstance
    .findActiveExecutionIn("wait for response")
    .getId();

processInstance = executionService.signalExecutionById(executionId, "accept");

assertTrue(processInstance.isActive("submit document"));</pre><p>Then the execution will continue over the outgoing transition named
        <code class="literal">accept</code>.  Analogue, when signalName <code class="literal">reject</code>
        is given in the signalExecutionXxx methods, the execution will continue over
        the outgoing transition named reject.
        </p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="decision"/>6.2.3. <code class="literal">decision</code></h3></div></div></div><p>Takes one path of many alternatives. Also known as a decision. A decision
      activity has multiple outgoing transitions and when an execution arrives in a decision
      activity, an automatic evaluation will decide which outgoing transition is taken.
      </p><p>A decision activity should be configured in one of the three following ways:
      </p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="decisionconditions"/>6.2.3.1. Decision conditions</h4></div></div></div><p>A decision with conditions on the transitions evaluates the condition in each transition.
        The first transition for which the nested condition expression resolves to true or which does
        not have a condition is taken.
        </p><div class="table"><a id="d0e2051"/><p class="title"><b>Table 6.5. <code class="literal">decision.transition.condition</code> attributes:</b></p><div class="table-contents"><table summary="decision.transition.condition attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">expr</code></td><td>expression</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>script that will be evaluated in the specified
                expression language.
                </td></tr><tr><td><code class="literal">lang</code></td><td>expression language</td><td>the <code class="literal">default-expression-language</code> taken from the <a href="#scripting" title="Chapter 8. Scripting"><code class="literal">script-manager</code> configuration</a></td><td>optional</td><td>the language in which <code class="literal">expr</code> is
                to be evaluated.
                </td></tr></tbody></table></div></div><br class="table-break"/><p>Example:
        </p><div class="figure"><a id="process.decision.condition"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.exclusive.png" align="middle" alt="The decision conditions example process"/></div></div><p class="title"><b>Figure 6.3. The decision conditions example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="DecisionConditions" &gt;

  &lt;start&gt;
    &lt;transition to="evaluate document" /&gt;
  &lt;/start&gt;

  &lt;decision name="evaluate document"&gt;
    &lt;transition to="submit document"&gt;
      <span class="bold"><strong>&lt;condition expr="#{content=="good"}" /&gt;</strong></span>
    &lt;/transition&gt;
    &lt;transition to="try again"&gt;
      <span class="bold"><strong>&lt;condition expr="#{content=="not so good"}" /&gt;</strong></span>
    &lt;/transition&gt;
    &lt;transition to="give up" /&gt;
  &lt;/decision&gt;

  &lt;state name="submit document" /&gt;

  &lt;state name="try again" /&gt;

  &lt;state name="give up" /&gt;

&lt;/process&gt;</pre><p>After starting a process instance with <code class="literal">good content</code></p><pre class="programlisting">Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();
variables.put("content", "good");
ProcessInstance processInstance =
    executionService.startProcessInstanceByKey("DecisionConditions", variables);</pre><p>The activity <code class="literal">submit document</code> will be active</p><pre class="programlisting">assertTrue(processInstance.isActive("submit document"));</pre><p>See the example unit test for more scenarios.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="decisionexpression"/>6.2.3.2. Decision expression</h4></div></div></div><p>A decision expression evaluates to a String representing the name of
        an outgoing transition.
        </p><div class="table"><a id="d0e2140"/><p class="title"><b>Table 6.6. <code class="literal">decision</code> attributes:</b></p><div class="table-contents"><table summary="decision attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">expr</code></td><td>expression</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>script that will be evaluated in the specified
                expression language.
                </td></tr><tr><td><code class="literal">lang</code></td><td>expression language</td><td>the <code class="literal">default-expression-language</code> taken from the <a href="#scripting" title="Chapter 8. Scripting"><code class="literal">script-manager</code> configuration</a></td><td>optional</td><td>the language in which <code class="literal">expr</code> is
                to be evaluated.
                </td></tr></tbody></table></div></div><br class="table-break"/><p>Example:
        </p><div class="figure"><a id="process.decision.expression"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.decision.png" align="middle" alt="The decision expression example process"/></div></div><p class="title"><b>Figure 6.4. The decision expression example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="DecisionExpression" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start &gt;
    &lt;transition to="evaluate document"/&gt;
  &lt;/start&gt;

  &lt;decision name="evaluate document" <span class="bold"><strong>expr="#{content}"</strong></span> &gt;
    &lt;transition <span class="bold"><strong>name="good"</strong></span> to="submit document"  /&gt;
    &lt;transition <span class="bold"><strong>name="bad"</strong></span>  to="try again"  /&gt;
    &lt;transition <span class="bold"><strong>name="ugly"</strong></span> to="give up"  /&gt;
  &lt;/decision&gt;

  &lt;state name="submit document"  /&gt;
  &lt;state name="try again"  /&gt;
  &lt;state name="give up"  /&gt;

&lt;/process&gt;</pre><p>When you start an new process instance with good content like this
        </p><pre class="programlisting">Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();
variables.put("content", "good");
ProcessInstance processInstance =
    executionService.startProcessInstanceByKey("DecisionExpression", variables);</pre><p>then the new execution will go to activity <code class="literal">submit document</code>.</p><p>See the example unit test for the other scenarios.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="decisionhandler"/>6.2.3.3. Decision handler</h4></div></div></div><p>A decision handler is a java class that implements the
        <code class="literal">DecisionHandler</code> interface.  The decision handler
        will be responsible for selecting the name of the outgoing transition.
        </p><pre class="programlisting">public interface DecisionHandler {
   String decide(OpenExecution execution);
}</pre><p>The handler is specified as a sub element of the decision.
        The configuration attributes and content of a decision <code class="literal">handler</code>
        element can be found in <a href="#usercode" title="6.7. User code">Section 6.7, “User code”</a>.
        </p><p>Here's an example process of a decision using a DecisionHandler:</p><div class="figure"><a id="process.decision.handler"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.decision.png" align="middle" alt="The decision handler example process"/></div></div><p class="title"><b>Figure 6.5. The decision handler example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="DecisionHandler"&gt;

  &lt;start&gt;
    &lt;transition to="evaluate document" /&gt;
  &lt;/start&gt;

  &lt;decision name="evaluate document"&gt;
    &lt;handler class="org.jbpm.examples.decision.handler.ContentEvaluation" /&gt;
    &lt;transition name="good" to="submit document" /&gt;
    &lt;transition name="bad" to="try again" /&gt;
    &lt;transition name="ugly" to="give up" /&gt;
  &lt;/decision&gt;

  &lt;state name="submit document" /&gt;

  &lt;state name="try again" /&gt;

  &lt;state name="give up" /&gt;

&lt;/process&gt;</pre><p>The ContentEvaluation class looks like this</p><pre class="programlisting">public class ContentEvaluation implements DecisionHandler {

  public String decide(OpenExecution execution) {
    String content = (String) execution.getVariable("content");
    if (content.equals("you're great")) {
      return "good";
    }
    if (content.equals("you gotta improve")) {
      return "bad";
    }
    return "ugly";
  }
}</pre><p>Now, when we start a process instance and supply value
        <code class="literal">you're great</code> for variable content, then the
        ContentEvaluation will return String <code class="literal">good</code> and
        the process instance will arrive in activity <code class="literal">Submit document</code>.
        </p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="concurrency"/>6.2.4. <code class="literal">concurrency</code></h3></div></div></div><p>Concurrent paths of executions can be modeled with the <code class="literal">fork</code> and
        <code class="literal">join</code> activities. The next table describes the <code class="literal">join</code>
        attributes; <code class="literal">fork</code> has no specific attributes.</p><div class="table"><a id="d0e2286"/><p class="title"><b>Table 6.7. <code class="literal">join</code> attributes:</b></p><div class="table-contents"><table summary="join attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">multiplicity</code></td><td>integer or expression</td><td>nbr of incoming transitions</td><td>optional</td><td>The number of executions that should arrive in this join
              before the join activates and push an execution out the single
              outgoing transition of the join.
              </td></tr><tr><td><code class="literal">lockmode</code></td><td>{none, read, upgrade, upgrade_nowait, write}</td><td>upgrade</td><td>optional</td><td>the hibernate lock mode applied on the parent execution to
              prevent that 2 concurrent transactions see each other as not yet
              arrived at the join, causing a process deadlock.
              </td></tr></tbody></table></div></div><br class="table-break"/><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2329"/>6.2.4.1. Parallel split with <code class="literal">fork</code></h4></div></div></div><p>The <code class="literal">fork</code> activity allows a single path of execution to be
        split into two or more branches which can execute activities concurrently.</p><div class="figure"><a id="process.concurrency"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.concurrency.png" align="middle" alt="Parallel split example process"/></div></div><p class="title"><b>Figure 6.6. Parallel split example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="ConcurrencyGraphBased" xmlns="http://jbpm.org/4.4/jpdl"&gt;

   &lt;start&gt;
      &lt;transition to="fork"/&gt;
   &lt;/start&gt;

   <span class="bold"><strong>&lt;fork name="fork"&gt;
      &lt;transition to="send invoice" /&gt;
      &lt;transition to="load truck"/&gt;
      &lt;transition to="print shipping documents" /&gt;
   &lt;/fork&gt;</strong></span>

   &lt;state name="send invoice" &gt;
      &lt;transition to="final join" /&gt;
   &lt;/state&gt;

   &lt;state name="load truck" &gt;
      &lt;transition to="shipping join" /&gt;
   &lt;/state&gt;

   &lt;state name="print shipping documents"&gt;
      &lt;transition to="shipping join" /&gt;
   &lt;/state&gt;

   <span class="bold"><strong>&lt;join name="shipping join" &gt;
      &lt;transition to="drive truck to destination" /&gt;
   &lt;/join&gt;</strong></span>

   &lt;state name="drive truck to destination" &gt;
      &lt;transition to="final join" /&gt;
   &lt;/state&gt;

   <span class="bold"><strong>&lt;join name="final join" &gt;
      &lt;transition to="end"/&gt;
   &lt;/join&gt;</strong></span>

   &lt;end name="end" /&gt;

&lt;/process&gt;</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="end"/>6.2.5. <code class="literal">end</code></h3></div></div></div><p>Ends the execution.
      </p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="endprocessinstance"/>6.2.5.1. <code class="literal">end</code> process instance</h4></div></div></div><p>By default, an end activity will end the complete
        process instance.  In case multiple concurrent executions
        are still active within the same process instance, all of
        them will be ended.
        </p><div class="figure"><a id="process.end.processinstance"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.end.processinstance.png" align="middle" alt="The end event"/></div></div><p class="title"><b>Figure 6.7. The end event</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="EndProcessInstance" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="end" /&gt;
  &lt;/start&gt;

  &lt;end name="end" /&gt;

&lt;/process&gt;</pre><p>When a new process instance is created, it immediately ends.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="endexecution"/>6.2.5.2. <code class="literal">end</code> execution</h4></div></div></div><p>Only the execution that arrives in the
        end activity will be ended and other concurrent executions
        should be left active.  To get this behaviour, set
        attribute <code class="literal">ends="execution"</code>
        </p><div class="table"><a id="d0e2390"/><p class="title"><b>Table 6.8. <code class="literal">end</code> execution attributes:</b></p><div class="table-contents"><table summary="end execution attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">ends</code></td><td>{processinstance|execution}</td><td>processinstance</td><td>optional</td><td>specifies if the whole process instance should be ended or
                just the path of execution that arrives in the end activity.
                </td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="endmultiple"/>6.2.5.3. <code class="literal">end</code> multiple</h4></div></div></div><p>A process can have multiple end events.  This can be handy to indicate
        different outcomes of a process instance.  For example
        </p><div class="figure"><a id="process.end.multiple"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.end.multiple.png" align="middle" alt="Multiple end events"/></div></div><p class="title"><b>Figure 6.8. Multiple end events</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="EndMultiple" xmlns="http://;jbpm.org/4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="get return code" /&gt;
  &lt;/start&gt;

  &lt;state name="get return code"&gt;
    &lt;transition name="200" to="ok"/&gt;
    &lt;transition name="400" to="bad request"/&gt;
    &lt;transition name="500" to="internal server error"/&gt;
  &lt;/state&gt;

  &lt;end name="ok"/&gt;
  &lt;end name="bad request"/&gt;
  &lt;end name="internal server error"/&gt;

&lt;/process&gt;
        </pre><p>Now if we would start an execution and signal it to move out of the <code class="literal">get return code</code> wait state with the
        following code, the execution would end with the <code class="literal">bad request</code> end event.</p><pre class="programlisting">ProcessInstance processInstance = executionService.startProcessInstanceByKey("EndMultiple");
String pid = processInstance.getId();
processInstance = executionService.signalExecutionById(pid, "400");</pre><p>Likewise, using the value <code class="literal">200</code> or <code class="literal">500</code> would cause the execution
        to end with the <code class="literal">ok</code> or with the <code class="literal">internal server error</code> end events
        respectively.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="endstate"/>6.2.5.4. <code class="literal">end</code> state</h4></div></div></div><p>An execution can also end with different states. It is another way to specify the outcome of a process.
        It is indicated by the <code class="literal">state</code> attribute of the end event or by the <code class="literal">end-cancel</code>
        and <code class="literal">end-error</code> shortcut notations.
        </p><div class="table"><a id="d0e2476"/><p class="title"><b>Table 6.9. <code class="literal">end</code> execution attributes:</b></p><div class="table-contents"><table summary="end execution attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">state</code></td><td>String</td><td> </td><td>optional</td><td>the state assigned to the execution.
                </td></tr></tbody></table></div></div><br class="table-break"/><p>Take for example the following process.
        </p><div class="figure"><a id="process.end.state"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.end.state.png" align="middle" alt="Different end states"/></div></div><p class="title"><b>Figure 6.9. Different end states</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="EndState" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
     &lt;transition to="get return code"/&gt;
  &lt;/start&gt;

  &lt;state name="get return code"&gt;
    &lt;transition name="200" to="ok"/&gt;
    &lt;transition name="400" to="bad request" /&gt;
    &lt;transition name="500" to="internal server error"/&gt;
  &lt;/state&gt;

  &lt;end name="ok" state="completed"/&gt;
  &lt;end-cancel name="bad request"/&gt;
  &lt;end-error name="internal server error"/&gt;

&lt;/process&gt;
        </pre><p>This time, if we would start an execution and signal it to move out of the <code class="literal">get return code</code> wait state with the
        following code, the execution would end with the <code class="literal">cancel</code> state.</p><p>Similarly, using the value <code class="literal">200</code> or <code class="literal">500</code> would cause the execution
        to end with the <code class="literal">completed</code> or with the <code class="literal">error</code> states
        respectively.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="task"/>6.2.6. <code class="literal">task</code></h3></div></div></div><p>Creates a task for a person in the task component.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="taskassignee"/>6.2.6.1. <code class="literal">task</code> assignee</h4></div></div></div><p>A simple task that will be assigned to a specific user
        </p><div class="table"><a id="d0e2553"/><p class="title"><b>Table 6.10. <code class="literal">task</code> attributes:</b></p><div class="table-contents"><table summary="task attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">assignee</code></td><td>expression</td><td> </td><td>optional</td><td>userId referring to the person that is responsible for
                completing this task.</td></tr></tbody></table></div></div><br class="table-break"/><div class="figure"><a id="process.task.assignee"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.task.png" align="middle" alt="The task assignee example process"/></div></div><p class="title"><b>Figure 6.10. The task assignee example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="TaskAssignee"&gt;

  &lt;start&gt;
    &lt;transition to="review" /&gt;
  &lt;/start&gt;

  &lt;task name="review"
        <span class="bold"><strong>assignee="#{order.owner}"</strong></span>&gt;

     &lt;transition to="wait" /&gt;
  &lt;/task&gt;

  &lt;state name="wait" /&gt;

&lt;/process&gt;</pre><p>This process shows 2 aspects of task assignment.  First, that the
        attribute <code class="literal">assignee</code> is used to indicate the user that is
        responsible for completing the task.  The assignee is a String property
        of a task and refers to a user.
        </p><p>Secondly, this attribute is by default evaluated as an expression.
        In this case the task is assigned to <code class="literal">#{order.owner}</code>.
        Which means that first an object is searched for with name order.  One of
        the places where this object is looked up is the process variables
        associated to the task.  Then the <code class="literal">getOwner()</code> getter
        will be used to get the userId that references the user that is
        responsible for completing this task.
        </p><p>Here's the Order class used in our example:</p><pre class="programlisting">public class Order implements Serializable {

  String owner;

  public Order(String owner) {
    this.owner = owner;
  }

  public String getOwner() {
    return owner;
  }

  public void setOwner(String owner) {
    this.owner = owner;
  }
}</pre><p>Next a new process instance is created with an order as a process
          variable.</p><pre class="programlisting">Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();
variables.put("order", new Order("johndoe"));
ProcessInstance processInstance = executionService
    .startProcessInstanceByKey("TaskAssignee", variables);</pre><p>Then the task list for <code class="literal">johndoe</code> can be obtained like this.</p><pre class="programlisting">List&lt;Task&gt; taskList = taskService.findPersonalTasks("johndoe");</pre><p>Note that it is also possible to put plain text like
        <code class="literal">assignee="johndoe"</code>.  In that case
        the task will be assigned to johndoe.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="taskcandidates"/>6.2.6.2. <code class="literal">task</code> candidates</h4></div></div></div><p>A task that will be offered to a group of users.  One of the users should then
        take the task in order to complete it.
        </p><div class="table"><a id="d0e2635"/><p class="title"><b>Table 6.11. <code class="literal">task</code> attributes:</b></p><div class="table-contents"><table summary="task attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">candidate-groups</code></td><td>expression</td><td> </td><td>optional</td><td>resolves to a comma separated list of groupIds.
                All the people in the groups will be candidates for this
                task.</td></tr><tr><td><code class="literal">candidate-users</code></td><td>expression</td><td> </td><td>optional</td><td>resolves to a comma separated list of userIds.
                All the users will be candidates for this task.</td></tr></tbody></table></div></div><br class="table-break"/><div class="figure"><a id="process.task.candidates"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.task.png" align="middle" alt="The task candidates example process"/></div></div><p class="title"><b>Figure 6.11. The task candidates example process</b></p></div><br class="figure-break"/><p>Here's an example process using task candidates:</p><pre class="programlisting">&lt;process name="TaskCandidates"&gt;

  &lt;start&gt;
    &lt;transition to="review" /&gt;
  &lt;/start&gt;

  &lt;task name="review"
        <span class="bold"><strong>candidate-groups="sales-dept"</strong></span>&gt;

     &lt;transition to="wait" /&gt;
  &lt;/task&gt;

  &lt;state name="wait"/&gt;

&lt;/process&gt;
        </pre><p>After starting, a task will be created.  The task will not show up in anyone's
        personal task list.  Following task lists will be empty.
        </p><pre class="programlisting">taskService.getPersonalTasks("johndoe");
taskService.getPersonalTasks("joesmoe");</pre><p>But the task will show up in the group task list of all members of the <code class="literal">sales-dept</code>
        group.
        </p><p>The in our example, the <code class="literal">sales-dept</code> has two members: johndoe and joesmoe</p><pre class="programlisting">identityService.createGroup("sales-dept");

identityService.createUser("johndoe", "johndoe", "John", "Doe");
identityService.createMembership("johndoe", "sales-dept");

identityService.createUser("joesmoe", "joesmoe", "Joe", "Smoe");
identityService.createMembership("joesmoe", "sales-dept"); </pre><p>So after the process is created, the task will appear in both the
        group tasks for users johndoe and joesmoe</p><pre class="programlisting">taskService.findGroupTasks("johndoe");
taskService.findGroupTasks("joesmoe");</pre><p>Candidates must take a task before they can work on it. This will prevent
        that two candides start working on the same task.  The user interface must only
        offer the action 'Take' for the tasks in the group task list.
        </p><pre class="programlisting">taskService.takeTask(task.getDbid(), "johndoe");</pre><p>When a user takes a task, the assignee of that task will be set to the given
        user.  The task will disappear from all the candidate's group task list and
        it will appear in the user's assigned tasks.
        </p><p>Users are only allowed to work on tasks in their personal task list.  This
        should be enforced by the user interface.</p><p>Similarly, the attribute <code class="literal">candidate-users</code> can be used that
        resolves to a comma separated list of userIds.  The <code class="literal">candidate-users</code>
        attribute can be used in combination with other assignment options.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="taskassignmenthandler"/>6.2.6.3. <code class="literal">task</code> assignment handler</h4></div></div></div><p>An <code class="literal">AssignmentHandler</code> can be used to calculate the
        assignee and the candidates for a task programmatically.
        </p><pre class="programlisting">public interface <span class="bold"><strong>AssignmentHandler</strong></span> extends Serializable {

  /** sets the actorId and candidates for the given assignable. */
  void assign(Assignable assignable, OpenExecution execution) throws Exception;
}</pre><p><code class="literal">Assignable</code> is a common interface for Tasks and
        Swimlanes.  So AssignmentHandlers can be used for tasks as well as swimlanes
        (see later).
        </p><p><code class="literal">assignment-handler</code> is a sub element of the task element.
        It specifies a user code object.  So the attributes and elements of <code class="literal">assignment-handler</code>
        are documented in <a href="#usercode" title="6.7. User code">Section 6.7, “User code”</a>
        </p><p>Let's look at the task assignment example process.</p><div class="figure"><a id="process.task.assignmenthandler"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.task.png" align="middle" alt="The task assignment handler example process"/></div></div><p class="title"><b>Figure 6.12. The task assignment handler example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="TaskAssignmentHandler" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start g="20,20,48,48"&gt;
    &lt;transition to="review" /&gt;
  &lt;/start&gt;

  &lt;task name="review" g="96,16,127,52"&gt;
    <span class="bold"><strong>&lt;assignment-handler class="org.jbpm.examples.task.assignmenthandler.AssignTask"&gt;
      &lt;field name="assignee"&gt;
        &lt;string value="johndoe" /&gt;
      &lt;/field&gt;
    &lt;/assignment-handler&gt;</strong></span>
    &lt;transition to="wait" /&gt;
  &lt;/task&gt;

  &lt;state name="wait" g="255,16,88,52" /&gt;

&lt;/process&gt;</pre><p>The referenced class <code class="literal">AssignTask</code> looks like this: </p><pre class="programlisting">public class AssignTask implements AssignmentHandler {

  String assignee;

  public void assign(Assignable assignable, OpenExecution execution) {
    assignable.setAssignee(assignee);
  }
}</pre><p>Please note that potentially, AssignmentHandler implementations can use
        the process variables and any other Java API to access resources like your
        application database to calculate the assignee and candidate users and groups.
        </p><p>Starting a new process instance of the <code class="literal">TaskAssignmentHandler</code>
        process will immediately bring the new execution to the task activity.  A new
        <code class="literal">review</code> task is created and at that point, the <code class="literal">AssignTask</code>
        assignment handler is called.  That will set <code class="literal">johndoe</code> as
        the assignee.  So John Doe will find the task in his personal task list.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="taskswimlanes"/>6.2.6.4. <code class="literal">task</code> swimlanes</h4></div></div></div><p>Multiple tasks in a process should be assigned to the same
        user or candidates.  Multiple tasks in a process can be associated to a
        single swimlane.  The process instance will remember the candidates and user
        that performed the first task in the swimlane.  And subsequent tasks in the
        same swimlane will be assigned to those user and candidates.
        </p><p>A swimlane can also be considered as a process role.  In some
        cases, this might boil down to authorization roles in the
        identity component.  But bare in mind that it is not always the
        same thing.</p><div class="table"><a id="d0e2800"/><p class="title"><b>Table 6.12. <code class="literal">task</code> attributes:</b></p><div class="table-contents"><table summary="task attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">swimlane</code></td><td>swimlane (string)</td><td> </td><td>optional</td><td>refers to a swimlane that is declared in the process</td></tr></tbody></table></div></div><br class="table-break"/><p>Swimlanes can be declared inside a process element:</p><div class="table"><a id="d0e2832"/><p class="title"><b>Table 6.13. <code class="literal">swimlane</code> attributes:</b></p><div class="table-contents"><table summary="swimlane attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>swimlane (string)</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>Name for this swimlane.  This is the
                name that will be referenced by task swimlane attributes.
                </td></tr><tr><td><code class="literal">assignee</code></td><td>expression</td><td> </td><td>optional</td><td>userId referring to the person that is responsible for
                completing this task.</td></tr><tr><td><code class="literal">candidate-groups</code></td><td>expression</td><td> </td><td>optional</td><td>resolves to a comma separated list of groupIds.
                All the people in the groups will be candidates for this
                the tasks in this swimlane.</td></tr><tr><td><code class="literal">candidate-users</code></td><td>expression</td><td> </td><td>optional</td><td>resolves to a comma separated list of userIds.
                All the users will be candidates for the
                tasks in this swimlane.</td></tr></tbody></table></div></div><br class="table-break"/><div class="figure"><a id="process.task.swimlane"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.task.png" align="middle" alt="The task swimlane example process"/></div></div><p class="title"><b>Figure 6.13. The task swimlane example process</b></p></div><br class="figure-break"/><p>The task swimlane example has the following process file :</p><pre class="programlisting">&lt;process name="TaskSwimlane" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  <span class="bold"><strong>&lt;swimlane name="sales representative"
            candidate-groups="sales-dept" /&gt;</strong></span>

  &lt;start&gt;
    &lt;transition to="enter order data" /&gt;
  &lt;/start&gt;

  &lt;task name="enter order data"
        <span class="bold"><strong>swimlane="sales representative"</strong></span>&gt;

    &lt;transition to="calculate quote"/&gt;
  &lt;/task&gt;

  &lt;task
      name="calculate quote"
      <span class="bold"><strong>swimlane="sales representative"</strong></span>&gt;
  &lt;/task&gt;

&lt;/process&gt;</pre><p>In this example we create the following information in the identity
        component:</p><pre class="programlisting">identityService.createGroup("sales-dept");

identityService.createUser("johndoe", "johndoe", "John", "Doe");
identityService.createMembership("johndoe", "sales-dept");</pre><p>After starting a new process instance, user <code class="literal">johndoe</code> will
        be a candidate for task <code class="literal">enter order data</code>.  Again like in the
        previous task candidates example, John Doe can now take this task like this:
        </p><pre class="programlisting">taskService.takeTask(taskDbid, "johndoe");</pre><p>Taking the task will make Lit<code class="literal">johndoe</code> the assignee for
        the task.  And since this task is coupled to the swimlane
        <code class="literal">sales representative</code>, assignee <code class="literal">johndoe</code> will
        also be propagated as the assignee in the swimlane.</p><p>Next, John Doe can complete the task like this:</p><pre class="programlisting">taskService.completeTask(taskDbid);</pre><p>Completing the task will bring the process execution to the
        next task, which is <code class="literal">calculate quote</code>.  Also
        this task is linked to the swimlane.  Therefore, the task will be
        assigned to <code class="literal">johndoe</code>.  Also the candidate users
        and candidate groups of the initial assignment will be copied from
        the swimlane to the task.  This is relevant in case user <code class="literal">johndoe</code>
        would release the task and offer it back to the other candidates.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="taskvariables"/>6.2.6.5. <code class="literal">task</code> variables</h4></div></div></div><p>Tasks can read and update process variables.  Later tasks will have
        the option to declare task-local process variables.  Task variables
        are an important part of the task forms.  Task forms typically show
        data that comes from the task and the process instance.  Then
        input from the user is translated in setting task variables.
        </p><p>Getting task variables can be done like this:</p><pre class="programlisting">List&lt;Task&gt; taskList = taskService.findPersonalTasks("johndoe");

Task task = taskList.get(0);
long taskDbid = task.getDbid();

Set&lt;String&gt; variableNames = taskService.getVariableNames(taskDbid);

Map&lt;String, Object&gt; variables = taskService.getVariables(taskDbid, variableNames);</pre><p>And setting task variables can be done like this:</p><pre class="programlisting">variables = new HashMap&lt;String, Object&gt;();
variables.put("category", "small");
variables.put("lires", 923874893);

taskService.setVariables(taskDbid, variables);</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="mailintasks"/>6.2.6.6. e-mail support in tasks</h4></div></div></div><p>It is possible to provide assignees with notifications when a task
          is added to their list, as well as reminders at specific intervals.
          Every email message is produced from a template. Templates may be specified
          inline or in the <code class="literal">process-engine-context</code> section of the
          configuration file.</p><div class="table"><a id="d0e2981"/><p class="title"><b>Table 6.14. <code class="literal">task</code> elements</b></p><div class="table-contents"><table summary="task elements" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td>notification</td><td>0..1</td><td>Sends a notification message when a task is assigned.
                  If no template is referenced or supplied inline, mail support
                  falls back on the template named <span class="emphasis"><em>task-notification</em></span>.
                  </td></tr><tr><td>reminder</td><td>0..1</td><td>Sends a reminder message at specific intervals.
                  If no template is referenced or supplied inline, mail support
                  falls back on the template named <span class="emphasis"><em>task-reminder</em></span>.
                  </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3016"/><p class="title"><b>Table 6.15. <code class="literal">notification</code> attributes:</b></p><div class="table-contents"><table summary="notification attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">continue</code></td><td>{sync | async | exclusive}</td><td>sync</td><td>optional</td><td>Specifies if an asynchronous continuation should be introduced
                right before sending this notification email.
                </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3047"/><p class="title"><b>Table 6.16. <code class="literal">reminder</code> attributes:</b></p><div class="table-contents"><table summary="reminder attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">duedate</code></td><td>duration (plain string or containing expression)</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>Delay before a reminder email should be send.
                </td></tr><tr><td><code class="literal">repeat</code></td><td>duration (plain string or containing expression)</td><td> </td><td>optional</td><td>Delay after a subsequent reminder email should be send</td></tr><tr><td><code class="literal">continue</code></td><td>{sync | async | exclusive}</td><td>sync</td><td>optional</td><td>Specifies if an asynchronous continuation should be introduced
                right before sending this notification email.
                </td></tr></tbody></table></div></div><br class="table-break"/><p>Here is a basic example that accepts the default templates.</p><pre class="programlisting">&lt;task name="review"
      assignee="#{order.owner}"
     &lt;notification/&gt;
     &lt;reminder duedate="2 days" repeat="1 day"/&gt;
&lt;/task&gt;</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="subprocess"/>6.2.7. <code class="literal">sub-process</code></h3></div></div></div><p>Creates a sub process instance and waits till it is completed.  When
      the sub process instance completes, then the execution in the sub-process
      will continue.
      </p><div class="table"><a id="d0e3112"/><p class="title"><b>Table 6.17. <code class="literal">sub-process</code> attributes:</b></p><div class="table-contents"><table summary="sub-process attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">sub-process-id</code></td><td>string or expression</td><td> </td><td>either this or sub-process-key is required</td><td>Identifies the sub process by the id.  This means that a specific
              version of a process definition is referenced. Sub process id can be specified as
              simple text or EL expression.</td></tr><tr><td><code class="literal">sub-process-key</code></td><td>string or expression</td><td> </td><td>either this or sub-process-key is required</td><td>Identifies the sub process by the key.  This means that the latest
              version of the process definition with the given key is referenced.  The latest version
              of the process is looked up each time the activity executes. Sub process key can be specified as
              simple text or EL expression.
              </td></tr><tr><td><code class="literal">outcome</code></td><td>expression</td><td> </td><td>required when transitions have <code class="literal">outcome-value</code>'s specified</td><td>Expression that is evaluated when the sub process
              instance ends.  The value is then used for outcome transition mapping.
              Add <code class="literal">outcome-value</code> elements to the outgoing transitions
              of this <code class="literal">sub-process</code> activity.
              </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3173"/><p class="title"><b>Table 6.18. <code class="literal">sub-process</code> elements:</b></p><div class="table-contents"><table summary="sub-process elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">parameter-in</code></td><td>0..*</td><td>Declares a variable that is passed to the sub process instance
                when it is created.
                </td></tr><tr><td><code class="literal">parameter-out</code></td><td>0..*</td><td>Declares a variable that will be set in the super process execution
                when the sub process ends.
                </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3205"/><p class="title"><b>Table 6.19. <code class="literal">parameter-in</code> attributes:</b></p><div class="table-contents"><table summary="parameter-in attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">subvar</code></td><td>string</td><td> </td><td><span class="bold"><strong>required</strong></span> </td><td>The name of the sub process variable in which the value is set.</td></tr><tr><td><code class="literal">var</code></td><td>string</td><td> </td><td>exactly one of {'var', 'expr'} is required to specify the value</td><td>The name of the variable in the super process execution context.</td></tr><tr><td><code class="literal">expr</code></td><td>string</td><td> </td><td>exactly one of {'var', 'expr'} is required to specify the value</td><td>An expression that will be resolved in the <span class="bold"><strong>super</strong></span> process execution
              context.  The resulting value will be set in the sub process variable.
              </td></tr><tr><td><code class="literal">lang</code></td><td>string</td><td>juel</td><td>optional</td><td>The scripting language in which the expression should be resolved.</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3274"/><p class="title"><b>Table 6.20. <code class="literal">parameter-out</code> attributes:</b></p><div class="table-contents"><table summary="parameter-out attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">var</code></td><td>string</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>The name of the variable in the super process execution context
              in which the value will be set.</td></tr><tr><td><code class="literal">subvar</code></td><td>string</td><td> </td><td>exactly one of {'subvar', 'expr'} is required to specify the value</td><td>The name of the sub process variable from which the value
              will be taken.</td></tr><tr><td><code class="literal">expr</code></td><td>string</td><td> </td><td>exactly one of {'subvar', 'expr'} is required to specify the value</td><td>An expression that will be resolved in the <span class="bold"><strong>sub</strong></span> process execution
              context.  The resulting value will be set in the super process variable.
              </td></tr><tr><td><code class="literal">lang</code></td><td>string</td><td>juel</td><td>optional</td><td>The scripting language in which the expression should be resolved.</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3342"/><p class="title"><b>Table 6.21. Extra <code class="literal">transition</code> elements in case of outcome variable mappings:</b></p><div class="table-contents"><table summary="Extra transition elements in case of outcome variable mappings:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">outcome-value</code></td><td>0..1</td><td>If the <code class="literal">outcome</code> matches the value, this
              transition is taken after the sub-process ended.  The value is specified with one child
              element.
              </td></tr></tbody></table></div></div><br class="table-break"/><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="subprocessvariables"/>6.2.7.1. <code class="literal">sub-process</code> variables</h4></div></div></div><p>The SubProcessVariables example scenario will show the basic workings of the
        sub-process activity, how to feed information in the sub process when it starts
        and how to extract information out of the subprocess when it ends.
        </p><p>The parent process involves a document that needs to be reviewed.</p><div class="figure"><a id="process.subprocess.variables.document"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.task.png" align="middle" alt="The subprocess document example process"/></div></div><p class="title"><b>Figure 6.14. The subprocess document example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="SubProcessDocument" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="review" /&gt;
  &lt;/start&gt;

  <span class="bold"><strong>&lt;sub-process name="review"
               sub-process-key="SubProcessReview"&gt;

    &lt;parameter-in var="document" subvar="document" /&gt;
    &lt;parameter-out var="reviewResult" subvar="result" /&gt;

    &lt;transition to="wait" /&gt;
  &lt;/sub-process&gt;</strong></span>

  &lt;state name="wait"/&gt;

&lt;/process&gt;</pre><p>The review process is a reusable process for all kinds of reviews.</p><div class="figure"><a id="process.subprocess.variables.review"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.subprocess.review.png" align="middle" alt="The subprocess review example process"/></div></div><p class="title"><b>Figure 6.15. The subprocess review example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="SubProcessReview" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="get approval"/&gt;
  &lt;/start&gt;

  &lt;task name="get approval"
        assignee="johndoe"&gt;

    &lt;transition to="end"/&gt;
  &lt;/task&gt;

  &lt;end name="end" /&gt;

&lt;/process&gt;</pre><p>The document process is started with a document variable:</p><pre class="programlisting">Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();
variables.put("document", "This document describes how we can make more money...");

ProcessInstance processInstance = executionService
    .startProcessInstanceByKey("SubProcessDocument", variables);</pre><p>Then the parent process execution will arrive in the sub process
        activity.  A sub process instance is created and linked with the super
        process execution.  When the <code class="literal">SubProcessReview</code> process
        instance starts, it arrives in the <code class="literal">task</code>.  A task will be
        created for <code class="literal">johndoe</code>.
        </p><pre class="programlisting">List&lt;Task&gt; taskList = taskService.findPersonalTasks("johndoe");
Task task = taskList.get(0);</pre><p>We can see that the document has been passed from the super process
        instance to the sub process instance:
        </p><pre class="programlisting">String document = (String) taskService.getVariable(task.getDbid(), "document");
assertEquals("This document describes how we can make more money...", document);</pre><p>Then we set a variable on the task.  This is typically done through a form.  But
        here we'll show how it is done programmatically.
        </p><pre class="programlisting">
Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();
variables.put("result", "accept");
taskService.setVariables(task.getDbid(), variables);</pre><p>Completing this task, will cause the sub process instance to end.
        </p><pre class="programlisting">taskService.completeTask(task.getDbid());</pre><p>When the sub process ends, the super process execution will get signalled(=notified).
        First the <code class="literal">result</code> variable from the sub process instance
        will be copied into the <code class="literal">reviewResult</code> variable in the
        super process execution.  Then the super process execution will continue
        and leave the review activity.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="subprocessoutcomevalue"/>6.2.7.2. <code class="literal">sub-process</code> outcome value</h4></div></div></div><p>In the <code class="literal">SubProcessOutcomeValueTest</code> example, the value
        of a sub process variable is used to select the outgoing transition
        of the <code class="literal">sub-process</code> activity.
        </p><div class="figure"><a id="process.subprocess.outcomevalue.document"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.subprocess.document.png" align="middle" alt="The subprocess document example process"/></div></div><p class="title"><b>Figure 6.16. The subprocess document example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="SubProcessDocument"&gt;

  &lt;start&gt;
    &lt;transition to="review" /&gt;
  &lt;/start&gt;

  &lt;sub-process name="review"
               sub-process-key="SubProcessReview"
               <span class="bold"><strong>outcome="#{result}"</strong></span>&gt;

    &lt;transition <span class="bold"><strong>name="ok"</strong></span> to="next step" /&gt;
    &lt;transition <span class="bold"><strong>name="nok"</strong></span> to="update" /&gt;
    &lt;transition <span class="bold"><strong>name="reject"</strong></span> to="close" /&gt;
  &lt;/sub-process&gt;

  &lt;state name="next step" /&gt;
  &lt;state name="update" /&gt;
  &lt;state name="close" /&gt;

&lt;/process&gt;</pre><p>The <code class="literal">SubProcessReview</code> is the same as above in the
        <a href="#subprocessvariables" title="6.2.7.1. sub-process variables">subprocess variables example</a>:</p><div class="figure"><a id="process.subprocess.outcomevalue.review"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.subprocess.review.png" align="middle" alt="The subprocess review example process for outcome value"/></div></div><p class="title"><b>Figure 6.17. The subprocess review example process for outcome value</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="SubProcessReview" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="get approval"/&gt;
  &lt;/start&gt;

  &lt;task name="get approval"
        assignee="johndoe"&gt;

    &lt;transition to="end"/&gt;
  &lt;/task&gt;

  &lt;end name="end" /&gt;

&lt;/process&gt;</pre><p>A new document process instance is started like usual:
        </p><pre class="programlisting">ProcessInstance processInstance = executionService
    .startProcessInstanceByKey("SubProcessDocument");</pre><p>Then task is fetched from <code class="literal">johndoe</code>'s task list</p><pre class="programlisting">List&lt;Task&gt; taskList = taskService.findPersonalTasks("johndoe");
Task task = taskList.get(0);
        </pre><p>Then the <code class="literal">result</code> variable is set and
        the task is completed.
        </p><pre class="programlisting">Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();
variables.put("result", "ok");
taskService.setVariables(task.getId(), variables);
taskService.completeTask(task.getDbid());</pre><p>In this scenario, the <code class="literal">ok</code> transition is taken in
        the parent process out of the sub-process review activity.  The example
        test case also shows other scenarios.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="subprocessoutcomeactivity"/>6.2.7.3. <code class="literal">sub-process</code> outcome activity</h4></div></div></div><p>A process can have many end activities.  In the <code class="literal">SubProcessOutcomeActivityTest</code>
        example, the resulting end activity is used to select the outgoing transition of the <code class="literal">sub-process</code>
        activity.
        </p><div class="figure"><a id="process.subprocess.outcomeactivity.document"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.subprocess.document.png" align="middle" alt="The subprocess document example process for outcome activity"/></div></div><p class="title"><b>Figure 6.18. The subprocess document example process for outcome activity</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="SubProcessDocument"&gt;

  &lt;start&gt;
    &lt;transition to="review" /&gt;
  &lt;/start&gt;

  &lt;sub-process name="review"
               sub-process-key="SubProcessReview"&gt;

    &lt;transition <span class="bold"><strong>name="ok"</strong></span> to="next step" /&gt;
    &lt;transition <span class="bold"><strong>name="nok"</strong></span> to="update" /&gt;
    &lt;transition <span class="bold"><strong>name="reject"</strong></span> to="close" /&gt;
  &lt;/sub-process&gt;

  &lt;state name="next step" /&gt;
  &lt;state name="update" /&gt;
  &lt;state name="close" /&gt;

&lt;/process&gt;</pre><p>The <code class="literal">SubProcessReview</code> now has multiple end activities:</p><div class="figure"><a id="process.subprocess.outcomeactivity.review"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.subprocess.outcomeactivity.review.png" align="middle" alt="The subprocess review example process for outcome activity"/></div></div><p class="title"><b>Figure 6.19. The subprocess review example process for outcome activity</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="SubProcessReview" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="get approval"/&gt;
  &lt;/start&gt;

  &lt;task name="get approval"
        assignee="johndoe"&gt;

    &lt;transition name="ok" to="ok"/&gt;
    &lt;transition name="nok" to="nok"/&gt;
    &lt;transition name="reject" to="reject"/&gt;
  &lt;/task&gt;

  <span class="bold"><strong>&lt;end name="ok" /&gt;
  &lt;end name="nok" /&gt;
  &lt;end name="reject" /&gt;</strong></span>

&lt;/process&gt;</pre><p>A new document process instance is started like usual:
        </p><pre class="programlisting">ProcessInstance processInstance = executionService
    .startProcessInstanceByKey("SubProcessDocument");</pre><p>Then task is fetched from <code class="literal">johndoe</code>'s task list</p><pre class="programlisting">List&lt;Task&gt; taskList = taskService.findPersonalTasks("johndoe");
Task task = taskList.get(0);
        </pre><p>Then the task is completed with outcome <code class="literal">ok</code>.
        </p><pre class="programlisting">taskService.completeTask(task.getDbid(), "ok");
        </pre><p>This will cause the sub process to end in end activity <code class="literal">ok</code>.
        The super process execution will then take outgoing transition <code class="literal">ok</code>
        to <code class="literal">next step</code>.
        </p><p>The example test case also shows the other scenarios.
        </p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="custom"/>6.2.8. <code class="literal">custom</code></h3></div></div></div><p>Invokes user code that implements custom behaviour of an activity.
      </p><p>A custom activity refers to user code.  See <a href="#usercode" title="6.7. User code">Section 6.7, “User code”</a>
      for more details on the specific attributes and elements.  Let's look at
      the example:
      </p><pre class="programlisting">&lt;process name="Custom" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start &gt;
    &lt;transition to="print dots" /&gt;
  &lt;/start&gt;

  &lt;custom name="print dots"
        class="org.jbpm.examples.custom.PrintDots"&gt;

    &lt;transition to="end" /&gt;
  &lt;/custom&gt;

  &lt;end name="end" /&gt;

&lt;/process&gt;</pre><p>The custom activity behaviour class <code class="literal">PrintDots</code>
      shows that it's possible to control the flow when implementing
      custom activity behaviours.  In this case the <code class="literal">PrintDots</code>
      acitivity implementation will after printing dots wait in the activity until
      a signal is given.
      </p><pre class="programlisting">public class PrintDots implements ExternalActivityBehaviour {

  private static final long serialVersionUID = 1L;

  public void execute(ActivityExecution execution) {
    String executionId = execution.getId();

    String dots = ...;

    System.out.println(dots);

    execution.waitForSignal();
  }

  public void signal(ActivityExecution execution,
                     String signalName,
                     Map&lt;String, ?&gt; parameters) {
    execution.take(signalName);
  }
}</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="automaticactivities"/>6.3. Automatic activities</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="java"/>6.3.1. <code class="literal">java</code></h3></div></div></div><p>The Java task. A process execution will execute the method of the class that is configured
      in this activity.</p><div class="table"><a id="d0e3627"/><p class="title"><b>Table 6.22. <code class="literal">java</code> attributes:</b></p><div class="table-contents"><table summary="java attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">class</code></td><td>classname</td><td> </td><td>either 'class' or 'expr' has to be specified</td><td>The fully qualified classname.  See <a href="#usercodeclassloading" title="6.7.2. User code classloading">Section 6.7.2, “User code classloading”</a>
              for classloading information.  The user code object will be lazy initialized
              and cached as part of the process definition.
              </td></tr><tr><td><code class="literal">expr</code></td><td>expression</td><td> </td><td>either 'expr' or 'class' has to be specified</td><td>An expression that returns the target object on which
              the method should be invoked.
              </td></tr><tr><td><code class="literal">method</code></td><td>methodname</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>The name of the method to invoke</td></tr><tr><td><code class="literal">var</code></td><td>variablename</td><td> </td><td>optional</td><td>The name of the variable in which the return value
              should be stored.
              </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3693"/><p class="title"><b>Table 6.23. <code class="literal">java</code> elements:</b></p><div class="table-contents"><table summary="java elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">field</code></td><td>0..*</td><td>describes a configuration value to inject in a memberfield before
              the method is invoked.</td></tr><tr><td><code class="literal">arg</code></td><td>0..*</td><td>method parameters</td></tr></tbody></table></div></div><br class="table-break"/><p>Consider the following example.</p><div class="figure"><a id="process.java"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.java.png" align="middle" alt="A java task"/></div></div><p class="title"><b>Figure 6.20. A java task</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="Java" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start &gt;
    &lt;transition to="greet" /&gt;
  &lt;/start&gt;

  &lt;java name="greet"
        class="org.jbpm.examples.java.JohnDoe"
        method="hello"
        var="answer"
        &gt;

    &lt;field name="state"&gt;&lt;string value="fine"/&gt;&lt;/field&gt;
    &lt;arg&gt;&lt;string value="Hi, how are you?"/&gt;&lt;/arg&gt;

    &lt;transition to="shake hand" /&gt;
  &lt;/java&gt;

  &lt;java name="shake hand"
        expr="#{hand}"
        method="shake"
        var="hand"
        &gt;

    &lt;arg&gt;&lt;object expr="#{joesmoe.handshakes.force}"/&gt;&lt;/arg&gt;
    &lt;arg&gt;&lt;object expr="#{joesmoe.handshakes.duration}"/&gt;&lt;/arg&gt;

    &lt;transition to="wait" /&gt;
  &lt;/java&gt;

  &lt;state name="wait" /&gt;

&lt;/process&gt;
      </pre><p>Classes involved:</p><pre class="programlisting">public class JohnDoe {

  String state;
  Session session;

  public String hello(String msg) {
    if ( (msg.indexOf("how are you?")!=-1)
         &amp;&amp; (session.isOpen())
       ) {
      return "I'm "+state+", thank you.";
    }
    return null;
  }
}</pre><pre class="programlisting">public class JoeSmoe implements Serializable {

  static Map&lt;String, Integer&gt; handshakes = new HashMap&lt;String, Integer&gt;();
  {
    handshakes.put("force", 5);
    handshakes.put("duration", 12);
  }

  public Map&lt;String, Integer&gt; getHandshakes() {
    return handshakes;
  }
}</pre><pre class="programlisting">public class Hand implements Serializable {

  private boolean isShaken;

  public Hand shake(Integer force, Integer duration) {
    if (force&gt;3 &amp;&amp; duration&gt;7) {
      isShaken = true;
    }

    return this;
  }

  public boolean isShaken() {
    return isShaken;
  }
}</pre><p>The first java activity <code class="literal">greet</code> specifies that during its execution an instance of the
      class <code class="literal">org.jbpm.examples.java.JohnDoe</code> will be instantiated and the method
      <code class="literal">hello</code> of this class will be invoked on the resulting object. The variable named
      <code class="literal">answer</code> will contain the result of the invocation.
      </p><p>The class above reveals that it contains two fields named <code class="literal">state</code> and <code class="literal">session</code>
      and that the method <code class="literal">hello</code> accepts one argument. During the execution the values specified in the
      <code class="literal">field</code> and <code class="literal">arg</code> configuration elements will be used. The expected result of creating
      a process instance is that the process variable <code class="literal">answer</code> contains the string
      <code class="literal">I'm fine, thank you.</code>.
      </p><p>The second java activity is named <code class="literal">shake hand</code>.  It will resolve
      expression <code class="literal">#{hand}</code>
      and capture the resulting object as the target object.  On that object, the method
      <code class="literal">shake</code> will be invoked.  The two arguments will be calculated by resolving
      the respective expressions <code class="literal">#{joesmoe.handshakes.force}</code> and
      <code class="literal">#{joesmoe.handshakes.duration}</code>.  The resulting object is a mofied
      version of the hand and <code class="literal">var="hand"</code> will cause the modified
      hand to overwrite the old <code class="literal">hand</code> variable value.
      </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="script"/>6.3.2. <code class="literal">script</code></h3></div></div></div><p>A script activity evaluates a script.  Scripts can be specified in any language for
      which there is <a xmlns:xlink="http://www.w3.org/1999/xlink" href="https://scripting.dev.java.net/">a JSR-223 compliant scripting engine</a>.
      Configuration of scripting engines <a href="#scripting" title="Chapter 8. Scripting">is explained below</a>.
      </p><p>There are 2 ways of specifying a script:
      </p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="script.expression"/>6.3.2.1. <code class="literal">script</code> expression</h4></div></div></div><p>The script is provided with the <code class="literal">expr</code> attribute.
        This is for short expressions that are easier expressed in an attribute
        then in a text element.  If no <code class="literal">lang</code> is specified,
        the default-expression-language is used.
        </p><div class="table"><a id="d0e3830"/><p class="title"><b>Table 6.24. <code class="literal">script</code> expression attributes:</b></p><div class="table-contents"><table summary="script expression attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">expr</code></td><td>text</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>the expression text to evaluate.</td></tr><tr><td><code class="literal">lang</code></td><td>scripting language name as defined in <a href="#scripting" title="Chapter 8. Scripting">Chapter 8, <i xmlns:xlink="http://www.w3.org/1999/xlink">Scripting</i></a></td><td>the default <span class="bold"><strong>expression</strong></span> language as defined in <a href="#scripting" title="Chapter 8. Scripting">Chapter 8, <i xmlns:xlink="http://www.w3.org/1999/xlink">Scripting</i></a></td><td>optional</td><td>the language in which the expression is specified.</td></tr><tr><td><code class="literal">var</code></td><td>variablename</td><td> </td><td>optional</td><td>name of the variable in which the return value
                should be stored.
                </td></tr></tbody></table></div></div><br class="table-break"/><p>In the next example, we'll see how a script activity with an expression and
        how the result is stored in a variable.
        </p><div class="figure"><a id="process.script.expression"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.script.png" align="middle" alt="The script.expression example process"/></div></div><p class="title"><b>Figure 6.21. The script.expression example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="ScriptExpression" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="invoke script" /&gt;
  &lt;/start&gt;

  <span class="bold"><strong>&lt;script name="invoke script"
          expr="Send packet to #{person.address}"
          var="text"&gt;</strong></span>

    &lt;transition to="wait" /&gt;
  <span class="bold"><strong>&lt;/script&gt;</strong></span>

  &lt;state name="wait"/&gt;

&lt;/process&gt;</pre><p>This example uses a <code class="literal">Person</code> class that looks like this.
        </p><pre class="programlisting">public class Person implements Serializable {

  String address;

  public Person(String address) {
    this.address = address;
  }

  public String getAddress() {
    return address;
  }

  public void setAddress(String address) {
    this.address = address;
  }
}</pre><p>When starting a process instance for this process, we supply a person
        with a given address property as variable <code class="literal">person</code>.
        </p><pre class="programlisting">Map&lt;String, Object&gt; variables = new HashMap&lt;String, Object&gt;();
variables.put("<span class="bold"><strong>person</strong></span>", <span class="bold"><strong>new Person("Honolulu")</strong></span>);

executionService.startProcessInstanceByKey("ScriptText", variables);</pre><p>After the execution of the script activity, variable <code class="literal">text</code>
        will contain 'Send packet to Honolulu'.
        </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a id="script.text"/>6.3.2.2. <code class="literal">script</code> text</h4></div></div></div><p>The second way of specifying a script is with a <code class="literal">text</code> element.
        This is convenient when the script text spans multiple lines.
        </p><div class="table"><a id="d0e3940"/><p class="title"><b>Table 6.25. <code class="literal">script</code> text attributes:</b></p><div class="table-contents"><table summary="script text attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">lang</code></td><td>scripting language name as defined in <a href="#scripting" title="Chapter 8. Scripting">Chapter 8, <i xmlns:xlink="http://www.w3.org/1999/xlink">Scripting</i></a></td><td>the default <span class="bold"><strong>scripting</strong></span> language as defined in <a href="#scripting" title="Chapter 8. Scripting">Chapter 8, <i xmlns:xlink="http://www.w3.org/1999/xlink">Scripting</i></a></td><td>optional</td><td>the language in which the script is specified.</td></tr><tr><td><code class="literal">var</code></td><td>variablename</td><td> </td><td>optional</td><td>name of the variable in which the return value
                should be stored.
                </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e3987"/><p class="title"><b>Table 6.26. <code class="literal">script</code> text elements:</b></p><div class="table-contents"><table summary="script text elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">text</code></td><td>1</td><td>contains the script text</td></tr></tbody></table></div></div><br class="table-break"/><p>For example</p><div class="figure"><a id="process.script.text"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.script.png" align="middle" alt="The script.text example process"/></div></div><p class="title"><b>Figure 6.22. The script.text example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="ScriptText" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="invoke script" /&gt;
  &lt;/start&gt;

  <span class="bold"><strong>&lt;script name="invoke script"
          var="text"&gt;
    &lt;text&gt;
      Send packet to #{person.address}
    &lt;/text&gt;</strong></span>
    &lt;transition to="wait" /&gt;
  <span class="bold"><strong>&lt;/script&gt;</strong></span>

  &lt;state name="wait"/&gt;

&lt;/process&gt;</pre></div><p>Execution of this process is exactly the same as with the script expression above.
      </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="hql"/>6.3.3. <code class="literal">hql</code></h3></div></div></div><p>With the <code class="literal">hql</code> activity, a HQL query can be performed
      on the database and the result is stored in a process variable.
      </p><div class="table"><a id="d0e4038"/><p class="title"><b>Table 6.27. <code class="literal">hql</code> attributes:</b></p><div class="table-contents"><table summary="hql attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">var</code></td><td>variablename</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>the name of the variable in which the result is stored.</td></tr><tr><td><code class="literal">unique</code></td><td>{true, false}</td><td>false</td><td>optional</td><td>a value of true means that the result from the hibernate
              query should be obtained with method <code class="literal">uniqueResult()</code>.
              The default is false and in that case the <code class="literal">list()</code>
              method will be used to get the result.
              </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4087"/><p class="title"><b>Table 6.28. <code class="literal">hql</code> elements:</b></p><div class="table-contents"><table summary="hql elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">query</code></td><td>1</td><td>The HQL query.</td></tr><tr><td><code class="literal">parameter</code></td><td>0..*</td><td>The query parameters</td></tr></tbody></table></div></div><br class="table-break"/><p>For example:</p><div class="figure"><a id="process.hql"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.hql.png" align="middle" alt="The hql example process"/></div></div><p class="title"><b>Figure 6.23. The hql example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="Hql" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="get process names" /&gt;
  &lt;/start&gt;

  <span class="bold"><strong>&lt;hql name="get process names"
       var="activities with o"&gt;
    &lt;query&gt;
      select activity.name
      from org.jbpm.pvm.internal.model.ActivityImpl as activity
      where activity.name like :activityName
    &lt;/query&gt;
    &lt;parameters&gt;
      &lt;string name="activityName" value="%o%" /&gt;
    &lt;/parameters&gt;</strong></span>
    &lt;transition to="count activities" /&gt;
  <span class="bold"><strong>&lt;/hql&gt;

  &lt;hql name="count activities"
       var="activities"
       unique="true"&gt;
    &lt;query&gt;
      select count(*)
      from org.jbpm.pvm.internal.model.ActivityImpl
    &lt;/query&gt;</strong></span>
    &lt;transition to="wait" /&gt;
  <span class="bold"><strong>&lt;/hql&gt;</strong></span>

  &lt;state name="wait"/&gt;

&lt;/process&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="sql"/>6.3.4. <code class="literal">sql</code></h3></div></div></div><p>The <code class="literal">sql</code> activity is exactly the same as the
      <a href="#hql" title="6.3.3. hql">hql</a> activity, with the only difference that
      <code class="literal">session.createSQLQuery(...)</code> is used.
      </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="mail"/>6.3.5. <code class="literal">mail</code></h3></div></div></div><p>Through the <code class="literal">mail</code> activity, process authors are
        able to specify the content of an email message to be sent to multiple
        recipients at once. Every email message is produced from a template.
        Templates may be specified inline or in the <code class="literal">process-engine-context
        </code> section of the configuration file.</p><div class="table"><a id="d0e4166"/><p class="title"><b>Table 6.29. <code class="literal">mail</code> attributes</b></p><div class="table-contents"><table summary="mail attributes" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td>template</td><td>string</td><td> </td><td>no</td><td>Reference to a <code class="literal">mail-template</code> element in the
                configuration file. If absent, the template must be specified
                inline using the child elements.</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4203"/><p class="title"><b>Table 6.30. <code class="literal">mail</code> elements</b></p><div class="table-contents"><table summary="mail elements" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td>from</td><td>0..1</td><td>list of sender(s)</td></tr><tr><td>to</td><td>1</td><td>list of primary recipients</td></tr><tr><td>cc</td><td>0..1</td><td>list of carbon copy recipients</td></tr><tr><td>bcc</td><td>0..1</td><td>list of blind carbon copy recipients</td></tr><tr><td>subject</td><td>1</td><td>text content of this element becomes the message subject</td></tr><tr><td>text</td><td>0..1</td><td>text content of this element becomes the message text content</td></tr><tr><td>html</td><td>0..1</td><td>text content of this element becomes the message HTML content</td></tr><tr><td>attachments</td><td>0..1</td><td>each attachment is configured in a separate subelement</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4277"/><p class="title"><b>Table 6.31. <code class="literal">attachment</code> attributes</b></p><div class="table-contents"><table summary="attachment attributes" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td>name</td><td>string</td><td> </td><td>no, unless <code class="literal">expression</code> is present</td><td><span class="emphasis"><em>File</em></span> name associated with this attachment.
          If absent, data sources that encapsulate files such as <code class="literal">resource</code>,
          <code class="literal">file</code> and <code class="literal">url</code> provide a reasonable
          fallback value.</td></tr><tr><td>description</td><td>string</td><td> </td><td>no</td><td>Descriptive information associated with this attachment.</td></tr><tr><td>expression</td><td>string</td><td> </td><td rowspan="4">one of <code class="literal">expression</code>, <code class="literal">file</code>,
          <code class="literal">url</code> or <code class="literal">resource</code> must be present</td><td>Expression that evaluates to a representation of the attachment data
         in the form of a Java object. Useful to extract content from process variables.</td></tr><tr><td>file</td><td>string</td><td> </td><td>Path to the attachment data in the file system. The denoted
           file must exist.</td></tr><tr><td>url</td><td>string</td><td> </td><td>Location of the attachment data in the worldwide web. The pointed
          resource must exist.</td></tr><tr><td>resource</td><td>string</td><td> </td><td>Name of the resource containing the attachment data in the class path.
          The denoted resource must exist.</td></tr><tr><td>mime-type</td><td>string</td><td> </td><td>no, unless <code class="literal">expression</code> is present</td><td>MIME type of the object returned by the expression.</td></tr></tbody></table></div></div><br class="table-break"/><p>Example usage:</p><pre class="programlisting">&lt;process name="InlineMail" xmlns="http://jbpm.org/4.4/jpdl"&gt;
  &lt;start&gt;
    &lt;transition to="send birthday reminder note" /&gt;
  &lt;/start&gt;
  &lt;mail name="send birthday reminder note"&gt;
    &lt;to addresses="johnDoe@some-company.com" /&gt;
    &lt;subject&gt;Reminder: ${person} celebrates his birthday!&lt;/subject&gt;
    &lt;text&gt;Do not forget: ${date} is the birthday of ${person} &lt;/text&gt;
    &lt;attachments&gt;
      &lt;attachment resource="org/example/birthday_card.png"/&gt;
      &lt;attachment name="picture.jpg" expression="${picture}" mime-type="image/jpeg"/&gt;
    &lt;/attachments&gt;
    &lt;transition to="end" /&gt;
  &lt;/mail&gt;
  &lt;state name="end"/&gt;
&lt;/process&gt;</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="commonactivitycontents"/>6.4. Common activity contents</h2></div></div></div><p>Unless specified otherwise above, all activities also include this
    content model:
    </p><div class="table"><a id="d0e4406"/><p class="title"><b>Table 6.32. Common activity attributes:</b></p><div class="table-contents"><table summary="Common activity attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>any text</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>name of the activity</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4435"/><p class="title"><b>Table 6.33. Common activity elements:</b></p><div class="table-contents"><table summary="Common activity elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">transition</code></td><td>0..*</td><td>the outgoing transitions</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="events"/>6.5. Events</h2></div></div></div><p>Events specify points in a process on which a list of event listeners can be registered.
    When an execution passes that point in the process, the event listeners are notified.
    The events and listeners are not shown in the graphical view of the process, which
    makes them very interesting for implementing technical details. An event
    is fired by an element in the process definition like e.g. the process definition,
    an activity or a transition.
    </p><p>The EventListener interface looks like this:
    </p><pre class="programlisting">public interface <span class="bold"><strong>EventListener</strong></span> extends Serializable {

  void notify(EventListenerExecution execution) throws Exception;

}</pre><p>All <a href="#automaticactivities" title="6.3. Automatic activities">automatic activities</a> can be used as
    event listeners as well.</p><p>To associate a list of event listeners with a process or an activity, use
    the <code class="literal">on</code> element to group the event listeners and specifiy the
    event.  <code class="literal">on</code> can be nested as a subelement of <code class="literal">process</code>
    or any activity.
    </p><p>To associate a list of event listeners with a transition <code class="literal">take</code>
    event, just include the event listeners directly in the <code class="literal">transition</code>
    element.
    </p><div class="table"><a id="d0e4495"/><p class="title"><b>Table 6.34. <code class="literal">on</code> attributes:</b></p><div class="table-contents"><table summary="on attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">event</code></td><td>{start | end}</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>name name of the event</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4526"/><p class="title"><b>Table 6.35. <code class="literal">on</code> elements:</b></p><div class="table-contents"><table summary="on elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">event-listener</code></td><td>0..*</td><td>An event listener implementation object.</td></tr><tr><td>any automatic activity</td><td>0..*</td><td> </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4555"/><p class="title"><b>Table 6.36. event listener attributes:</b></p><div class="table-contents"><p><code class="literal">event-listener</code> is user code so it can be configured
      like described in <a href="#usercode" title="6.7. User code">Section 6.7, “User code”</a>.
      </p><p>Any automatic activities (including event-listener) that are placed on
      events can specify following additional attributes:
      </p><table summary="event listener attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">propagation</code></td><td>{enabled | disabled | true | false | on | off}</td><td>disabled</td><td>optional</td><td>indicates if the event listener should also be invoked for
            propagating events.
            </td></tr><tr><td><code class="literal">continue</code></td><td>{sync | async | exclusive}</td><td>sync</td><td>optional</td><td>indicates if the execution should be continued asynchronously
            right before the event listener is executed.  @see also
            <a href="#asynchronouscontinuations" title="6.6. Asynchronous continuations">Section 6.6, “Asynchronous continuations”</a>
            </td></tr></tbody></table></div></div><br class="table-break"/><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4606"/>6.5.1. Event listener example</h3></div></div></div><p>Let's look at an example process with event listeners:</p><div class="figure"><a id="process.eventlistener"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.eventlistener.png" align="middle" alt="The event listener example process"/></div></div><p class="title"><b>Figure 6.24. The event listener example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="EventListener" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;on event="start"&gt;
    &lt;event-listener class="org.jbpm.examples.eventlistener.LogListener"&gt;
      &lt;field name="msg"&gt;&lt;string value="start on process definition"/&gt;&lt;/field&gt;
    &lt;/event-listener&gt;
  &lt;/on&gt;

  &lt;start&gt;
    &lt;transition to="wait"/&gt;
  &lt;/start&gt;

  &lt;state name="wait"&gt;
    &lt;on event="start"&gt;
      &lt;event-listener class="org.jbpm.examples.eventlistener.LogListener"&gt;
        &lt;field name="msg"&gt;&lt;string value="start on activity wait"/&gt;&lt;/field&gt;
      &lt;/event-listener&gt;
    &lt;/on&gt;
    &lt;on event="end"&gt;
      &lt;event-listener class="org.jbpm.examples.eventlistener.LogListener"&gt;
        &lt;field name="msg"&gt;&lt;string value="end on activity wait"/&gt;&lt;/field&gt;
      &lt;/event-listener&gt;
    &lt;/on&gt;
    &lt;transition to="park"&gt;
      &lt;event-listener class="org.jbpm.examples.eventlistener.LogListener"&gt;
        &lt;field name="msg"&gt;&lt;string value="take transition"/&gt;&lt;/field&gt;
      &lt;/event-listener&gt;
    &lt;/transition&gt;
  &lt;/state&gt;

  &lt;state name="park"/&gt;

&lt;/process&gt;</pre><p><code class="literal">LogListener</code>  will maintain a list of logs as a process variable:</p><pre class="programlisting">public class <span class="bold"><strong>LogListener</strong></span> implements EventListener {

  // value gets injected from process definition
  String msg;

  public void notify(EventListenerExecution execution) {
    List&lt;String&gt; logs = (List&lt;String&gt;) execution.getVariable("logs");
    if (logs==null) {
      logs = new ArrayList&lt;String&gt;();
      execution.setVariable("logs", logs);
    }

    logs.add(msg);

    execution.setVariable("logs", logs);
  }
}</pre><p>Next, we start a new process instance.</p><pre class="programlisting">ProcessInstance processInstance = executionService.startProcessInstanceByKey("EventListener");</pre><p>Then the process instance executes up to the wait activity.  So we provide a signal
        and that will cause it to execute till the end.</p><pre class="programlisting">Execution execution = processInstance.findActiveExecutionIn("wait");
executionService.signalExecutionById(execution.getId());</pre><p>The list of log messages will now look like this:</p><pre class="programlisting">[start on process definition,
 start on activity wait,
 end on activity wait,
 take transition]</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="d0e4640"/>6.5.2. Event propagation</h3></div></div></div><p>Events are propagated from activities and transitions to outer activities and
      eventually to the process definition.
      </p><p>By default, event listeners are only invoked
      for events that are fired on the elements on which the event listeners are subscribed.
      But by specifying <code class="literal">propagation="enabled"</code>, the event
      listener will also be invoked for all events that are fired on contained elements.
      </p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="asynchronouscontinuations"/>6.6. Asynchronous continuations</h2></div></div></div><p>Each invocation of <code class="literal">ExecutionService.startProcessInstanceById(...)</code>
    or <code class="literal">ExecutionService.signalProcessInstanceById(...)</code> will cause
    the process to be executed in the thread it was called from (=client).  In other words, those
    methods will only return after the process execution has arrived in a wait state.
    </p><p>This default behaviour has a couple of advantages: user application transactions
    can be easily propagated to jBPM to that jBPM's DB updates are done in the user's
    transaction context.  Secondly, it's possible for a client to get an exception in
    case something goes wrong during execution of the process.  Usually, the automatic
    work that has to be done as part of the process inbetween two wait states is
    relatively small.  Even if multiple automatic activities
    are executed inbetween 2 wait states.   So in most situations, it's good to
    do all that work in a single transaction. This explains that the default behaviour
    of jPDL is to perform all work of the process synchronously in the thread of client.
    </p><p>For those cases where you don't want the call to jBPM to be blocking until
    all the automatic work is done, jPDL allows for very fine grained control over
    transaction boundaries.  On various places in the process, asynchronous continuations
    can be introduced.  Asynchronous continuations cause the transaction to commit and
    the jBPM method invocation will return.  jBPM will then start a new transaction in a
    new thread and continue the rest of the automatic process work asynchronously.  jBPM
    uses asynchronous messaging internally to accomplish this.
    </p><p>Upon an asynchronous continuation, an asynchronous message will be sent as
    part of the currently ongoing transaction.  And then the originally invoked method
    like e.g. <code class="literal">startProcessInstanceById(...)</code>
    or <code class="literal">signalProcessInstanceById(...)</code> will return.  When the
    asynchronous message is committed and then processed, it will start a new transaction
    and resume execution where it left off.
    </p><div class="table"><a id="d0e4673"/><p class="title"><b>Table 6.37. Attribute of any activity, <code class="literal">transition</code> or <code class="literal">on</code>:</b></p><div class="table-contents"><table summary="Attribute of any activity, transition or on:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">continue</code></td><td>{sync | async | exclusive}</td><td>sync</td><td>optional</td><td><p>indicates if an asynchronous continuation should be performed
              before the element is executed.</p>
            </td></tr></tbody></table></div></div><br class="table-break"/><div class="itemizedlist"><ul><li><span class="bold"><strong>sync</strong></span> (default) keep executing
      the element as part of the ongoing transaction.
      </li><li><span class="bold"><strong>async</strong></span> introduces an asynchronous
      continuation (aka safe point).
      The ongoing transaction is committed and the element is executed in a
      new transaction.  Transactional asynchronous messaging is used by the jBPM
      implementation to achieve this.
      </li><li><span class="bold"><strong>exclusive</strong></span> introduces a asynchronous
      continuation (aka safe point).
      The ongoing transaction is committed and the element is executed in a
      new transaction.  Transactional asynchronous messaging is used by the jBPM
      implementation to achieve this.  Exclusive messages will not be processed
      concurrently.  jBPM will make sure that exclusive jobs for the same process instance
      are not executed concurrently, even if your jBPM configuration has multiple
      asynchronous message processors (like the JobExecutor) running on different
      systems.    This can be used to prevent optimistic locking failures in case
      multiple, potentially conflicting jobs are scheduled in the same transaction.
      </li></ul></div><p>Let's look at a couple of examples.</p><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="asyncactivity"/>6.6.1. Async activity</h3></div></div></div><div class="figure"><a id="process.async.activity"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.async.activity.png" align="middle" alt="The async activity example process"/></div></div><p class="title"><b>Figure 6.25. The async activity example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="AsyncActivity" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start&gt;
    &lt;transition to="generate pdf"/&gt;
  &lt;/start&gt;

  &lt;java name="generate pdf"
        <span class="bold"><strong>continue="async"</strong></span>
        class="org.jbpm.examples.async.activity.Application"
        method="generatePdf" &gt;
    &lt;transition to="calculate primes"/&gt;
  &lt;/java&gt;

  &lt;java name="calculate primes"
        <span class="bold"><strong>continue="async"</strong></span>
        class="org.jbpm.examples.async.activity.Application"
        method="calculatePrimes"&gt;
    &lt;transition to="end"/&gt;
  &lt;/java&gt;

  &lt;end name="end"/&gt;

&lt;/process&gt;</pre><pre class="programlisting">public class Application {

  public void generatePdf() {
    // assume long automatic calculations here
  }

  public void calculatePrimes() {
    // assume long automatic calculations here
  }
}</pre><pre class="programlisting">ProcessInstance processInstance =
     executionService.startProcessInstanceByKey("AsyncActivity");
String processInstanceId = processInstance.getId();</pre><p>Without the asynchronous continuations, this would be an all automatic
      process and the process would execute all the way up to the end
      in method <code class="literal">startProcessInstanceByKey</code>
      </p><p>But with <code class="literal">continue="async"</code> the execution only
      goes untill it is about to execute activity <code class="literal">generate pdf</code>. Then
      an asynchronous continuation message is send and the <code class="literal">startProcessInstanceByKey</code>
      method returns.
      </p><p>In a normal configuration, the job executor will automatically pick up
      the message and execute it.  But for testing scenarios and for these examples we
      want to control when messages are executed so the job executor is not configured.
      Therefore we have to execute the jobs manually like this:
      </p><pre class="programlisting">Job job = managementService.createJobQuery()
  .processInstanceId(processInstanceId)
  .uniqueResult();
managementService.executeJob(job.getDbid());</pre><p>That will bring the process until it's about to execute activity
      <code class="literal">calculate primes</code> and again an asynchronous message is
      send.
      </p><p>Then the message can be looked up again and when that message
      is executed, that transaction will run the execution till the end.
      </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="asyncfork"/>6.6.2. Async fork</h3></div></div></div><div class="figure"><a id="process.async.fork"/><div class="figure-contents"><div class="mediaobject" align="center"><img src="images/process.async.fork.png" align="middle" alt="The async fork example process"/></div></div><p class="title"><b>Figure 6.26. The async fork example process</b></p></div><br class="figure-break"/><pre class="programlisting">&lt;process name="AsyncFork" xmlns="http://jbpm.org/4.4/jpdl"&gt;

  &lt;start &gt;
    &lt;transition to="fork"/&gt;
  &lt;/start&gt;

  &lt;fork &gt;
    <span class="bold"><strong>&lt;on event="end" continue="exclusive" /&gt;</strong></span>
    &lt;transition /&gt;
    &lt;transition /&gt;
  &lt;/fork&gt;

  &lt;java class="org.jbpm.examples.async.fork.Application" &gt;
    &lt;transition /&gt;
  &lt;/java&gt;

  &lt;java class="org.jbpm.examples.async.fork.Application" &gt;
    &lt;transition /&gt;
  &lt;/java&gt;

  &lt;join &gt;
    &lt;transition to="end"/&gt;
  &lt;/join&gt;

  &lt;end /&gt;

&lt;/process&gt;</pre><pre class="programlisting">public class Application {

  public void shipGoods() {
    // assume automatic calculations here
  }

  public void sendBill() {
    // assume automatic calculations here
  }
}</pre><p>By placing the asynchronous continuation on the <code class="literal">end</code>
      event of the fork (<code class="literal">&lt;on event="end" continue="exclusive" /&gt;</code>),
      each forked execution that takes a transition out of the
      fork will be continued asynchronously.
      </p><p>Value <code class="literal">exclusive</code> was selected to serialize the executions of
      the 2 asynchonous continuation jobs resulting from the fork. The respective transactions
      that will execute activities <code class="literal">ship goods</code>
      and <code class="literal">send bill</code> will both arrive at the join.  At the join, both
      transactions will synchronize on the same execution (read: update the same execution
      row in the DB), resulting in a potential optimistic locking failure.
      </p><pre class="programlisting">ProcessInstance processInstance = executionService.startProcessInstanceByKey("AsyncFork");
String processInstanceId = processInstance.getId();

List&lt;Job&gt; jobs = managementService.createJobQuery()
  .processInstanceId(processInstanceId)
  .list();

assertEquals(2, jobs.size());

Job job = jobs.get(0);

// here we simulate execution of the job,
// which is normally done by the job executor
managementService.executeJob(job.getDbid());

job = jobs.get(1);

// here we simulate execution of the job,
// which is normally done by the job executor
managementService.executeJob(job.getDbid());

Date endTime = historyService
  .createHistoryProcessInstanceQuery()
  .processInstanceId(processInstance.getId())
  .uniqueResult()
  .getEndTime();

assertNotNull(endTime);</pre></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="usercode"/>6.7. User code</h2></div></div></div><p>Various elements in the jPDL process language refer to a an
    object on which an interface method will be invoked.  This section
    describes the common attributes and elements for the instantiation and
    configuration of such user code objects.
    </p><div class="itemizedlist"><ul><li><code class="literal">custom</code></li><li><code class="literal">event-listener</code></li><li><code class="literal">assignment-handler</code> in task</li><li><code class="literal">handler</code> in decision</li><li><code class="literal">condition</code> in transition</li></ul></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="usercodeconfiguration"/>6.7.1. User code configuration</h3></div></div></div><div class="table"><a id="d0e4837"/><p class="title"><b>Table 6.38. attributes:</b></p><div class="table-contents"><table summary="attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">class</code></td><td>classname</td><td> </td><td>one of {class|expr} is required</td><td>The fully qualified classname.  Instantiation is done only once and
              the user object is cached as part of the process definition.
              </td></tr><tr><td><code class="literal">expr</code></td><td>expression</td><td> </td><td>one of {class|expr} is required</td><td>Expression for which the resulting value will be taken as the target object.
              Expressions will be evaluated for every usage.  In other words, the resulting
              value of the evaluation will not be cached.
              </td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4876"/><p class="title"><b>Table 6.39. user code configuration elements:</b></p><div class="table-contents"><table summary="user code configuration elements:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">field</code></td><td>0..*</td><td>describes a configuration value to be injected directly in
              a memberfield before this user class is used.</td></tr><tr><td><code class="literal">property</code></td><td>0..*</td><td>describes a configuration value to injected through a setter
              method before this user object is used.</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4905"/><p class="title"><b>Table 6.40. <code class="literal">field</code> and <code class="literal">property</code> attributes:</b></p><div class="table-contents"><table summary="field and property attributes:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>string</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>the name of the field or property.</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e4939"/><p class="title"><b>Table 6.41. field and property contained element:</b></p><div class="table-contents"><p><code class="literal">field</code> and <code class="literal">property</code> elements
        have exactly one child element that represents the value that will be
        injected.
        </p><table summary="field and property contained element:" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">string</code></td><td>0..1</td><td>a java.lang.String</td></tr><tr><td><code class="literal">int</code></td><td>0..1</td><td>a java.lang.Integer</td></tr><tr><td><code class="literal">long</code></td><td>0..1</td><td>a java.lang.Long</td></tr><tr><td><code class="literal">float</code></td><td>0..1</td><td>a java.lang.Float</td></tr><tr><td><code class="literal">double</code></td><td>0..1</td><td>a java.lang.Double</td></tr><tr><td><code class="literal">true</code></td><td>0..1</td><td>Boolean.TRUE</td></tr><tr><td><code class="literal">false</code></td><td>0..1</td><td>Boolean.FALSE</td></tr><tr><td><code class="literal">object</code></td><td>0..1</td><td>a object that will be instantiated with reflection</td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e5023"/><p class="title"><b>Table 6.42. Attribute for basic type <code class="literal">string</code>, <code class="literal">int</code>, <code class="literal">long</code>, <code class="literal">float</code>and <code class="literal">double</code>:</b></p><div class="table-contents"><table summary="Attribute for basic type string, int, long, floatand double:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">value</code></td><td>text</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>text value that will be parsed to the respective type</td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a id="usercodeclassloading"/>6.7.2. User code classloading</h3></div></div></div><p>Process definitions are cached.  By default, all user code objects are
      cached as part of those process definitions.

      For all objects that are referenced by a class name, will be
      instantiated during parsing time.  Which implies that the objects aren't
      allowed to store non-stateless data (ie which can change).
      This is typically OK since those objects are in practice almost always immutable.
      If you do need to use 'dynamic' data in your user code, you can always
      fall back to process variables (or Environment.get(xxx) calls).
      </p><p>Objects that are referenced by an expression are calculated
      dynamically.
      </p><p>The devguide also explains an unsupported attribute to prevent
      that user objects are cached.
      </p></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="variables"/>Chapter 7. Variables</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e5153">7.1. Variable scoping</a></span></dt><dt><span class="section"><a href="#d0e5171">7.2. Variable types</a></span></dt><dt><span class="section"><a href="#d0e5209">7.3. Updating serialized process variables</a></span></dt><dt><span class="section"><a href="#d0e5231">7.4. Declared variables</a></span></dt><dt><span class="section"><a href="#variablehistory">7.5. Variables history</a></span></dt></dl></div><p>Process variables can be accessed from outside the process with methods from the <code class="literal">ExecutionService</code>:
  </p><div class="itemizedlist"><ul><li><code class="literal">ProcessInstance startProcessInstanceById(String processDefinitionId, Map&lt;String, Object&gt; variables);</code></li><li><code class="literal">ProcessInstance startProcessInstanceById(String processDefinitionId, Map&lt;String, Object&gt; variables, String processInstanceKey);</code></li><li><code class="literal">ProcessInstance startProcessInstanceByKey(String processDefinitionKey, Map&lt;String, ?&gt; variables);</code></li><li><code class="literal">ProcessInstance startProcessInstanceByKey(String processDefinitionKey, Map&lt;String, ?&gt; variables, String processInstanceKey);</code></li><li><code class="literal">void setVariable(String executionId, String name, Object value);</code></li><li><code class="literal">void setVariables(String executionId, Map&lt;String, ?&gt; variables);</code></li><li><code class="literal">Object getVariable(String executionId, String variableName);</code></li><li><code class="literal">Set&lt;String&gt; getVariableNames(String executionId);</code></li><li><code class="literal">Map&lt;String, Object&gt; getVariables(String executionId, Set&lt;String&gt; variableNames);</code></li></ul></div><p>And from inside the process with methods from Execution interfaces passed to user code like 
  <code class="literal">ActivityExecution</code> and <code class="literal">EventListenerExecution</code>:
  </p><div class="itemizedlist"><ul><li><code class="literal">Object getVariable(String key);</code></li><li><code class="literal">void setVariables(Map&lt;String, ?&gt; variables);</code></li><li><code class="literal">boolean hasVariable(String key);</code></li><li><code class="literal">boolean removeVariable(String key);</code></li><li><code class="literal">void removeVariables();</code></li><li><code class="literal">boolean hasVariables();</code></li><li><code class="literal">Set&lt;String&gt; getVariableKeys();</code></li><li><code class="literal">Map&lt;String, Object&gt; getVariables();</code></li><li><code class="literal">void createVariable(String key, Object value);</code></li><li><code class="literal">void createVariable(String key, Object value, String typeName);</code></li></ul></div><p>jBPM doesn't have a mechanism for detecting changes automatically to variable values.  So if you
  get e.g. a serializable collection from the process variables and add an element, then you need to 
  set the changed variable value explicitely for the changes to be saved to the DB.   
  </p><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5153"/>7.1. Variable scoping</h2></div></div></div><p>By default variables are created in the top level process instance scope.  This means they are 
    visible and accessible in all the paths of execution of the whole process instance.  Process variables are 
    created dynamically.  Meaning that a variable is created the first time it is set 
    through one of these methods.
    </p><p>Each execution is a variable scope.  Variables declared in a nested execution level will 'see'
    their own variables and variables declared in parent executions according to the normal scoping rules.
    With the <code class="literal">createVariable</code> methods in the execution interfaces <code class="literal">ActivityExecution</code>
    and <code class="literal">EventListenerExecution</code>, execution-local variables can be created. 
    </p><p>In one of the future releases, we might add variable declaration in the jPDL process language.
	  </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5171"/>7.2. Variable types</h2></div></div></div><p>jBPM supports following Java types as process variables:</p><div class="itemizedlist"><ul><li>java.lang.String</li><li>java.lang.Long</li><li>java.lang.Double</li><li>java.util.Date</li><li>java.lang.Boolean</li><li>java.lang.Character</li><li>java.lang.Byte</li><li>java.lang.Short</li><li>java.lang.Integer</li><li>java.lang.Float</li><li>byte[] (byte array)</li><li>char[] (char array)</li><li>hibernate entity with a long id</li><li>hibernate entity with a string id</li><li>serializable</li></ul></div><p>For persistence of these variable, the type of the variable is 
    checked in the order of this list.  The first match will determine how 
    the variable is stored.
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5209"/>7.3. Updating serialized process variables</h2></div></div></div><p>(Since jBPM 4.3)</p><p>In <code class="literal">custom</code>s, <code class="literal">event-handler</code>s and other 
    user code, you can retrieve process variables.  In case a process variable 
    is stored as a serialized object, you can just make updates to your deserialized 
    objects without the need for an explicit save.  jBPM will manage deserialized process 
    variables and update them automatically if you change.  For example (@see examples package 
    org.jbpm.examples.serializedobject), look at this piece of user code inside a <code class="literal">custom</code>'s activity behaviour:   
    </p><pre class="programlisting">public class UpdateSerializedVariables implements ActivityBehaviour {

  public void execute(ActivityExecution execution) {
    Set&lt;String&gt; messages = (Set&lt;String&gt;) execution.getVariable("messages");
    messages.clear();
    messages.add("i");
    messages.add("was");
    messages.add("updated");
  }
}</pre><p>When the transaction commits in which this usercode was called, the
    updated messages set will be updated in the database automatically.  
    </p><p>When reading process variables that are stored in serialized format from the DB 
    jBPM will monitor that deserialized object.  Right before the commit of the transaction,
    jBPM will serialize and update the variable automatically if that is necessary.  jBPM 
    will ignore updates to the deserialized object if another object was set as the value 
    in that scope  (which even can be of another type).  jBPM will also skip updating of the 
    variable if the deserialized object has not been changed.  The check to see if the 
    object has changed is based on comparing the byte arrays from serializing the object 
    again and comparing that with the byte array that was originally loaded from the db.   
    </p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5231"/>7.4. Declared variables</h2></div></div></div><p>(Since jBPM 4.4)</p><p>
    Variables can be declared directly in process definition (JPDL). These variables 
    will be created at process instance startup. There can be more than one variable definition.
    </p><p>There are several possible ways for declaring variable:</p><div class="itemizedlist"><ul><li>declare <code class="literal">String</code> variable initialized with static text
    		<pre class="programlisting">
&lt;variable name="declaredVar" type="string" init-expr="testing declared variable"/&gt;
    		</pre></li><li>declare <code class="literal">custom</code> variable initialized with EL
    		<pre class="programlisting">
&lt;variable name="declaredVar" type="long" init-expr="#{anotherVar}"/&gt;
    		</pre></li><li>declare <code class="literal">custom</code> variable initialized with serializable class
    		<pre class="programlisting">
&lt;variable name="declaredVar" type="serializable" &gt;
   &lt;object class="org.jbpm.examples.variable.declared.HistoryVariable" /&gt;
&lt;/variable&gt;
    		</pre></li></ul></div><p>As shown above variable values can be assigned in two ways: using attribute <code class="literal">init-expr</code> or
    by nesting init descriptor (element <code class="literal">object</code>) within variable tags. 
    </p><p>
    Note: Only one of value assignment can be used for a variable declaration.  
    </p><div class="table"><a id="d0e5272"/><p class="title"><b>Table 7.1. Attribute for  <code class="literal">variable</code> element:</b></p><div class="table-contents"><table summary="Attribute for  variable element:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Required?</th><th>Description</th></tr></thead><tbody><tr><td><code class="literal">name</code></td><td>text</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>name of the variable</td></tr><tr><td><code class="literal">type</code></td><td>text</td><td> </td><td><span class="bold"><strong>required</strong></span></td><td>type of the variable, must refer to types defined in jbpm.variable.types.xml</td></tr><tr><td><code class="literal">init-expr</code></td><td>text (EL expression)</td><td> </td><td><span class="bold"><strong>optional</strong></span></td><td>value for the variable, this attribute or nested element must be given</td></tr><tr><td><code class="literal">init-expr-type</code></td><td>text</td><td>UEL</td><td><span class="bold"><strong>optional</strong></span></td><td>defines language for expression evaluation</td></tr><tr><td><code class="literal">history</code></td><td>boolean</td><td>false</td><td><span class="bold"><strong>optional</strong></span></td><td>indicates wheater variable should be stored in history or not - default false, 
    for more information about history see <a href="#variablehistory" title="7.5. Variables history">Section 7.5, “Variables history”</a></td></tr></tbody></table></div></div><br class="table-break"/><div class="table"><a id="d0e5355"/><p class="title"><b>Table 7.2. Nested element for <code class="literal">variable</code>:</b></p><div class="table-contents"><table summary="Nested element for variable:" border="1"><colgroup><col/><col/><col/><col/><col/></colgroup><thead><tr><th>Element</th><th>Multiplicity</th><th>Description</th><td class="auto-generated"> </td><td class="auto-generated"> </td></tr></thead><tbody><tr><td><code class="literal">object</code></td><td>1</td><td>Value for the variable as custom object, either this element or <code class="literal">init-expr</code> attribute must be specified</td><td class="auto-generated"> </td><td class="auto-generated"> </td></tr></tbody></table></div></div><br class="table-break"/></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="variablehistory"/>7.5. Variables history</h2></div></div></div><p>(Since jBPM 4.4)</p><p>Variables can be marked to be persisted as history records. This means that once process instance is ended and 
    its runtime information is removed, history details are preserved. 
    </p><p>History can be enabled for variable in two ways:</p><div class="itemizedlist"><ul><li>via public API <code class="literal">ExecutionService</code>:
	    	<div class="itemizedlist"><ul><li><code class="literal">void createVariable(String executionId, String name, Object value, boolean historyEnabled);</code></li><li><code class="literal">void createVariables(String executionId, Map&lt;String, ?&gt; variables, boolean historyEnabled);</code></li></ul></div></li><li>on variable declaration
    	<pre class="programlisting">
&lt;variable name="declaredVar" type="string" init-expr="testing declared variable" history="true"/&gt;
    		</pre></li></ul></div><p>Currently all variables are persisted in history as <code class="literal">String</code> values.
    Variable (regardless of its type) will be converted to a string value using <code class="literal">toString()</code>
    method. In case of custom objects they should override <code class="literal">toString()</code> method to provide string representation
    of the variable that will be available as history record. This will provide an easy way for enabling convienient search
    capabilities based on variable values. </p><p>Access to history variables is given via <code class="literal">HistoryService</code> methods:</p><div class="itemizedlist"><ul><li><code class="literal">Object getVariable(String processInstnceId, String name);</code></li><li><code class="literal">Map&lt;String, Object&gt; getVariables(String processInstnceId, Set&lt;String&gt; variableNames);</code></li><li><code class="literal">Set&lt;String&gt; getVariableNames(String processInstnceId);</code></li></ul></div></div></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="scripting"/>Chapter 8. Scripting</h2></div></div></div><p>Only jUEL is configured as the scripting language.  jUEL is 
  an implementation of the Unified Expression Language.  For detailed description 
  of how to use UEL, please refer to  
  <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/javaee/5/docs/tutorial/doc/bnahq.html">
  the JEE 5 Tutorial, section Unified Expression Language</a>  
  </p><p>To configure other scripting languages then jUEL, please 
  refer to the developer's guide (non supported).
  </p></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="configuration"/>Chapter 9. Configuration</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#d0e5447">9.1. Business calendar</a></span></dt><dt><span class="section"><a href="#d0e5454">9.2. Console</a></span></dt><dt><span class="section"><a href="#d0e5467">9.3. Email</a></span></dt></dl></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5447"/>9.1. Business calendar</h2></div></div></div><p>To customize the business calendar configuration,
      remove the default business calendar configuration import
      and replace it with the custom values.
    </p><pre class="programlisting">&lt;jbpm-configuration&gt;

  &lt;import resource="jbpm.businesscalendar.cfg.xml" /&gt;
  ...

  &lt;process-engine-context&gt;
    &lt;business-calendar&gt;
      &lt;monday    hours="9:00-18:00"/&gt;
      &lt;tuesday   hours="9:00-18:00"/&gt;
      &lt;wednesday hours="9:00-18:00"/&gt;
      &lt;thursday  hours="9:00-18:00"/&gt;
      &lt;friday    hours="9:00-18:00"/&gt;
      &lt;holiday period="01/02/2009 - 31/10/2009"/&gt;
    &lt;/business-calendar&gt;
  &lt;/process-engine-context&gt;

&lt;/jbpm-configuration&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5454"/>9.2. Console</h2></div></div></div><p>By default the server host and port of the console
    web app are respectively <code class="literal">localhost</code>
    and <code class="literal">8080</code>. It is not hard to imagine
    situations where it is needed to change those defaults.
    Hence they are made configurable. To customize,
    change the values of the default configuration
    (e.g. in the file "jbpm.console.cfg.xml")
    and replace them with the values you want.</p><pre class="programlisting">&lt;jbpm-configuration&gt;

  &lt;process-engine-context&gt;
    &lt;string name="jbpm.console.server.host" value="myNewHost"&gt;
    &lt;string name="jbpm.console.server.port" value="9191"&gt;
  &lt;/process-engine-context&gt;

&lt;/jbpm-configuration&gt;</pre></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="d0e5467"/>9.3. Email</h2></div></div></div><p>The default configuration looks for a <code class="literal">jbpm.mail.properties</code>
      classpath resource containing <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://java.sun.com/products/javamail/javadocs/">JavaMail properties</a>.
      To send mail through a server other than local host, set the
      <code class="literal">mail.smtp.host</code> property in the mail properties file.</p><pre class="programlisting">mail.smtp.host=localhost
mail.smtp.port=25
mail.from=noreply@jbpm.org</pre><p>If the SMTP server requires authentication, the application can supply a
      custom authenticator in the configuration file.</p><pre class="programlisting">&lt;mail-session&gt;
  &lt;mail-server&gt;
    &lt;session-properties resource="jbpm.mail.properties" /&gt;
    &lt;authenticator class='BasicAuthenticator'&gt;
      &lt;field name='userName'&gt;&lt;string value='aguizar'/&gt;&lt;/field&gt;
      &lt;field name='password'&gt;&lt;string value='wontsay'/&gt;&lt;/field&gt;
    &lt;/authenticator&gt;
  &lt;/mail-server&gt;
&lt;/mail-session&gt;</pre><p>In Java EE environments it is often the case that a mail session is already
      configured and bound to JNDI. To employ such a session, specify its JNDI name in
      the configuration file.</p><pre class="programlisting">&lt;mail-session&gt;
  &lt;mail-server session-jndi='java:comp/env/mail/smtp' /&gt;
&lt;/mail-session&gt;</pre><div xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="important"><h2>Important</h2><p>If present, the session JNDI name has precedence over the session
      properties and the authenticator. The combined absence of session-properties
      and session-jndi constitutes an error.</p></div><p>Refer to the <a xmlns:xlink="http://www.w3.org/1999/xlink" href="http://docs.jboss.com/jbpm/v4/devguide/html_single/#mailsupport">Developer
      Guide</a> for advanced, yet unsupported, email settings.</p></div></div></div></body></html>